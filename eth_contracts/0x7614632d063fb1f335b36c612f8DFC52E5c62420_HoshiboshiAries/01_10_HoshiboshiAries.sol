// SPDX-License-Identifier: MIT

// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@&#GPYJJ???JY5G#&@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@&B5?!~::...       ..^!JP&@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@&G?!^:::....:::........    :!5&@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@#Y~::^:::........:..::.......   :?#@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@&5~:.::::.....::..::   .:::.:...... :J&@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@B7~:........::::.:.::^:.. .:::^^:......^[email protected]@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@5~~::::...:::::::::..:.^!~:...^^^~^....:[email protected]@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@?^^.:::.::::::::.::^. .::^7!~:..:~~!~.:::::.7&@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@J:^ ::.~..::.:..  ~^.!^...^~77!~:..~~7~::::::.7&@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@G:^^.~ .~  .  ...:.:?~:?!~~^:^7?!~:.:~!J^:^:::::7&@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@7~~^~~.~!:~:..::^^::^7~^!!!77~~77~^:.:~7?::^::::^[email protected]@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@B~!!~7~:77:7^::::~!^:.~7!7!!!7??7?!~::.77J~:^^:::^[email protected]@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@G!!~~?~^??^!7^^:::77^^!?7!~^^^~!777~^::~7J?:^~:::^[email protected]@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@G7!~~?!^?777?!^^^:^77~^!77!~~^^^^~!~~:^^777~:!::^^[email protected]@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@B!!~~7?~7~?J7?!^^^^^!!!!!~~^^^^^^^~!~^^~?!7~^!::^^~77#@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@#!!~~!J??!!??77!!~~~~^~^^^^~~!7??~~!~~^!7!!~^7::~^[email protected]@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@B~!~~~7?!^~~!7!~~~^^^^^^^!7JYYJ7~~!!!!~77~~7!!^^[email protected]@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@5!~!~^~!!~^^^^^^^^^^^^^^^~~~!!!!!!7!?~7!^!7?7~^^~~~J&[email protected]@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@Y?~!!^^:^~~~~!77~^::^^^^^~~~!!!!!77J!7JYJ?7?!~^^^~^P&[email protected]@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@YJ!!!!~^:~?J?J7~~~^^^^^^^^~~~~~~!!?!!??5Y?7!!~~^~~!&B&@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@Y57!~!!!~!7?7!!!~~~^^^^^^~^^^^^^~~^~7!~JY?!!!~^~~~P#&@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@P5Y!!~!!!!!7??7!~~~^^~~^~~^^^^^~^:!?!~^JJ77!^.^!~Y#&@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@&Y&?~!!~!7?J5P5?!~^^^^^^^^^^^^^:~77~~^!??7~::[email protected]@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@BG&?~?7~!!!77J?!~^~~^^^^^^^^~!??!~~^~JJ7~^~?!Y?&@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@&#&J~!^::..::.::^^^~7?7!~7???7!~!^:?J?!~!GP!#P&@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@BJ!:..:^^::~!^^.::.:~?#&&?7!~~~~::[email protected]&5#@&@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@#P?~:...:::~77^:^7B7.!7.!!!B#7~~~~^:::?J?77!?Y5P#&&@@@&&&&&@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@&7^:::^^^^~~!!!!!^:!!7:!?:!Y~~7~~~~^::::~Y??~:^^~~75Y7~~~^^^^~75&@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@&!.::::^~~?GPY?!!77^7YY~^7~^!~~~~~~~^^^^^:~7J!^^^^7GY^.::::::...:[email protected]@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@#~.:::::^^7&@&Y7!7!YP5J!~~~~^~^^~~~~~~~^^^^::^~~~^7#J::^^::::::::::^[email protected]@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@&~.:::::^^?&@&?!!!7PBY~^^~~^^::::^^^^^^^::::::::::~BY:^!!^::.....::::!&@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@&!.:::.:^~?&@@Y~~~JG5!^^^^~~^::....:::::::::::::::^B5::77^:.........::^[email protected]@@@@@@
// @@@@@@@@@@@@@@@@@@@@&!.:::.:^~!#@@57~~J57^^^^^^^^^::::::::::::::::::::^PG^:~7~:...........:^[email protected]@@@@@@
// @@@@@@@@@@@@@@@@@@@@7.:...:^[email protected]@B!JJJ!~^...::^^^~~~~~^::::::::::::~7!?P?~~?~:...........::^[email protected]@@@@@@
// @@@@@@@@@@@@@@@@@@@J.:...::[email protected]#?!7!~7^.......:~77!~^::............~7JP?7~7!:............:^~&@@@@@@@
// @@@@@@@@@@@@@@@@@@5.:....:^~!J?~^::.~^.......^!!~^::............:^!!7PG!~!7^.............:^[email protected]@@@@@@@
// @@@@@@@@@@@@@@@@@B:::....^~~^::.....:......:!!~^::...............:^:?G7~~7!:............:^!&@@@@@@@@
// @@@@@@@@@@@@@@@@&~.:...^JY?7^:............:!~^^:..........:^^~!!!~~!YY^^~7^.............:[email protected]@@@@@@@@
// @@@@@@@@@@@@@@@@7.::..~YPPJJJ?!~~~^^::::::!7!~~~~~~~^~!?Y555J7JJY55555:^7~:............:^[email protected]@@@@@@@@@
// @@@@@@@@@@@@@@@Y::::.!P5Y55JJYY!~~!!~^^^^~J???7!~^^~7J5PY????JY5YYJJJG?!7^:::.........::[email protected]@@@@@@@@@@
// @@@@@@@@@@@@@@B::::.^P55YJP5JJ7?J?^:^~!!77J!!~^~!?Y5J?J77?JYY5Y?????JP#J~^::::::...::::[email protected]@@@@@@@@@@@
// @@@@@@@@@@@@@@!::::.7G5YJJPJ555??JJ777!!!?Y?775PYYY??7?JYYYJ?Y?7??Y?YGP!~:::::::::::::~#@@@@@@@@@@@@
// @@@@@@@@@@@@@P:::::.7GP5YYP?JY5P5YJJYJ7!7JYYPGPYYJYJJJ?Y5????Y??JY55GG?~^^:::::::::::~#@@@@@@@@@@@@@
// @@@@@@@@@@@@&!:::::.:5G555PJ??55Y5P5YY5555YYP5P5PPYJY??Y5????YJY55PGBY!~^^^^::::::::^[email protected]@@@@@@@@@@@@@
// @@@@@@@@@@@@P:::::::.^YPPGG5YJ55JYYG5YYY?JJ?JYY5PPYYJJY5PYJJYPP55PPPP7~~~^^^^::::::^[email protected]@@@@@@@@@@@@@@
// @@@@@@@@@@@@J::::::::^!7Y5PGP555555GGP57?YYJ7!?5PPP55PGGG555PP5Y5PPP?!~~~^^^^^^^^::[email protected]@@@@@@@@@@@@@@@
// @@@@@@@@@@@@?:::::::^!!~~?JYY5PPGGGGPPPJJJ7?JJJPPPP5PPPGPP55P55PPPPY!~~~~^^^^^^^^^[email protected]@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@J::::::^~!!!~7?77YP55P5P555J77!777?Y555YYPP5Y55PYYP55YY7!~~~~^^^^^^^^[email protected]@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@P^::::^~!!!!~??!~J5YYYY55JYJ~~!!~^~?5YYYY5YJ?Y5Y?J55YJ?!!~~~~^^^^^^^[email protected]@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@&~:^^~~!!!!!!?!!!5GYJ?JYYJJ?~~~~~~~!YYJJJJJ???J??JYYJJ!!~~~~~^^^^^^!&@@@@@@@@@@@@@@@@@@@

pragma solidity >=0.8.9 <0.9.0;

import 'erc721a/contracts/ERC721A.sol';
import '@openzeppelin/contracts/access/Ownable.sol';
import '@openzeppelin/contracts/security/ReentrancyGuard.sol';
import '@openzeppelin/contracts/utils/cryptography/MerkleProof.sol';
import {DefaultOperatorFilterer} from "operator-filter-registry/src/DefaultOperatorFilterer.sol";
import "operator-filter-registry/src/OperatorFilterer.sol";

contract HoshiboshiAries is ERC721A, Ownable, ReentrancyGuard, DefaultOperatorFilterer {

    uint public immutable maxSupply = 2222;
    string private baseURI = 'https://arweave.net/EjXvp352tuJ0zHQ_Yt1DXb7_Np5JhqyhoifwfhshQCM/';

    bytes32 private phase0MerkleRoot;
    bytes32 private phase1MerkleRoot;
    bool public phase0MintOpenStatus = false;
    bool public phase1MintOpenStatus = false;
    mapping(address => uint) public phase0MintCountMap;

    constructor() ERC721A('HoshiboshiAries', 'HoshiboshiAries') {
    }

    function updateBaseURI(string memory baseURI_) public onlyOwner {
        baseURI = baseURI_;
    }

    function updatePhase0MerkleRoot(bytes32 phase0MerkleRoot_) public onlyOwner {
        phase0MerkleRoot = phase0MerkleRoot_;
    }

    function updatePhase1MerkleRoot(bytes32 phase1MerkleRoot_) public onlyOwner {
        phase1MerkleRoot = phase1MerkleRoot_;
    }

    function updatePhase0OpenStatus(bool phase0MintOpenStatus_) public onlyOwner {
        phase0MintOpenStatus = phase0MintOpenStatus_;
    }

    function updatePhase1OpenStatus(bool phase1MintOpenStatus_) public onlyOwner {
        phase1MintOpenStatus = phase1MintOpenStatus_;
    }

    function withdraw() public onlyOwner nonReentrant {
        (bool os,) = payable(owner()).call{value : address(this).balance}('');
        require(os);
    }

    function _baseURI() internal view virtual override returns (string memory) {
        return baseURI;
    }

    function _startTokenId() internal view virtual override returns (uint256) {
        return 1;
    }

    // mint

    function airdrop(address[] memory toAddresses, uint[] memory mintCounts) public onlyOwner {
        for (uint i = 0; i < toAddresses.length; i++) {
            _doMint(toAddresses[i], mintCounts[i]);
        }
    }

    function getPhase0MintMaxCanMintCount(address msgSender, uint snapShotCount, bytes32[] calldata snapShotMerkleProof, bytes32[] calldata whiteListMerkleProof) public view returns (uint) {
        uint canMintCount = 0;
        bool isInSnapShot = MerkleProof.verify(snapShotMerkleProof, phase0MerkleRoot, keccak256(abi.encodePacked(msgSender, snapShotCount)));
        if (isInSnapShot) {
            canMintCount += snapShotCount;
        }
        bool isInWhiteList = MerkleProof.verify(whiteListMerkleProof, phase0MerkleRoot, keccak256(abi.encodePacked(msgSender)));
        if (isInWhiteList) {
            canMintCount += 1;
        }
        return canMintCount;
    }

    function phase0Mint(uint snapShotCount, bytes32[] calldata snapShotMerkleProof, bytes32[] calldata whiteListMerkleProof) external payable {
        address msgSender = _msgSender();

        require(tx.origin == msgSender, 'Only EOA!');
        require(phase0MintOpenStatus, 'Phase0Mint is not open!');

        uint mintCount = getPhase0MintMaxCanMintCount(msgSender, snapShotCount, snapShotMerkleProof, whiteListMerkleProof);
        if (phase0MintCountMap[msgSender] <= mintCount) {
            mintCount -= phase0MintCountMap[msgSender];
        } else {
            mintCount = 0;
        }

        _doMint(msgSender, mintCount);
        phase0MintCountMap[msgSender] += mintCount;
    }

    function phase1Mint(bytes32[] calldata phase1MerkleProof) external payable {
        address msgSender = _msgSender();

        require(tx.origin == msgSender, 'Only EOA!');
        require(phase1MintOpenStatus, 'Phase1Mint is not open!');

        bool canMint = MerkleProof.verify(phase1MerkleProof, phase1MerkleRoot, keccak256(abi.encodePacked(msgSender)));
        require(canMint, 'Permission denied!');

        _doMint(msgSender, 1);
    }

    function _doMint(address to, uint quantity) private {
        require(quantity > 0, 'Quantity invalid!');
        require(totalSupply() + quantity <= maxSupply, 'Max supply exceeded!');
        _safeMint(to, quantity);
    }

    // OpenSea DefaultOperator

    function setApprovalForAll(address operator, bool approved) public override onlyAllowedOperatorApproval(operator) {
        super.setApprovalForAll(operator, approved);
    }

    function approve(address operator, uint256 tokenId) public payable override onlyAllowedOperatorApproval(operator) {
        super.approve(operator, tokenId);
    }

    function transferFrom(address from, address to, uint256 tokenId) public payable override onlyAllowedOperator(from) {
        super.transferFrom(from, to, tokenId);
    }

    function safeTransferFrom(address from, address to, uint256 tokenId) public payable override onlyAllowedOperator(from) {
        super.safeTransferFrom(from, to, tokenId);
    }

    function safeTransferFrom(address from, address to, uint256 tokenId, bytes memory data)
    public payable
    override
    onlyAllowedOperator(from)
    {
        super.safeTransferFrom(from, to, tokenId, data);
    }
}