// SPDX-License-Identifier: MIT
//                                              .,,.   .*&@     ....                                                                
//                                        ,@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@                                                  
//                                 [email protected]@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@                                             
//                              *@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@&                                      
//                        *  @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@,                                   
//                      %@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@.                                
//                    #@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@,                               
//                   ,@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@                              
//                  @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@                            
//              @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@                           
//           *@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@&.   *@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@                          
//        .#@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%#*             [email protected]@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@*                        
//        #@@@@@@@@@@@@@@@@@@@@@@@@@@@@@#                              [email protected]@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@.                       
//        @@@@@@@@@@@@@@@@@@@@@@@@@%.                                   @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@                       
//         @@@@@@@@@@@@@.                                              *@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@                       
//        ,@@@@@@@@@@*                                                 (@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@&                      
//           @@@@@@@                                                    %@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@.                     
//           [email protected]#@@@                  *@@@(.                                *@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@&                     
//             %@@@        &@      .&@#.                                      %@@@@@@@@@@@@@@@@@@@@@@(      %@%                     
//            @@@@    ,@,     .*       &@@@@@@@%                                %@@@@@@@@@@@@@@@@@@.  /@#*,/&/ @                    
//            [email protected]@@  [email protected]    *@@@   @  /@@@@@@@@@@@@@@@@@@@@@@#                     [email protected]@@@@@@@@@@@@@@@  @/        %[email protected]                   
//             @@@     &@@@@@   #   (&&#((#@@@@@@@@@@@@@@@@@@@@@,                  @@@@@@@@@@@@*   *           @**                  
//             ,,@  *@@@@@@@/ @.,@              &@@@@@@@@@@@@@@@@ *@&              &@@@@@@@@@                   @%                  
//               ,@@@@@@@@     /  /                            . (&                ,@@@@@@@         @(@%    / * .&                  
//              @@@@@@@@                       [email protected]@%%@@/.     &@,  &@&%             [email protected]@@@@@         (#        &% /%                  
//            *@@@@@@@&   ,@@(   @#     @     & @@@@@@&#(((     %@@@                              .          @% ,#                  
//            &@@@@@            & %#    @      ,          .,                                       @,       @ @ .#                  
//             /@@,     #@@@@@@@@@*@            @    ,@@(                                           @     .*.   .(                  
//              #@   @@@@&       @.(                                                               .% @&        @                   
//                @&(&%        @@*@@                                                               ..          @                    
//                  @&*./(*    (& &,                                                                         @.                     
//                  @@#      *(  [email protected]                                                                       [email protected]&                       
//                 .*       @    @             #. ,@/    [email protected]%                                        @@@, *@@&                       
//                 &      [email protected]    @                   @        @#                                     @    @@@.                       
//                @       @   @/          *@@@& ,@%           #@         @.                        @   /@@@                        
//                (      (,   @         @.                       #*        @                        &   @@@.                        
//                @      / /@  .((,                                & /#    #.                      ,@/  @@@                         
//                 @      @                   /&@%/,..  .*#@@@(    ,( @     %                      .## ,@@@                         
//                  @,    &         .&@#.      /@@@@@%@@@@@&@@&@@@* @ #     &                       *# %@@/                         
//                   [email protected]   @      @#    (&@@@@# @&  %      / ,@ @@@@ @.,,   %.                        ( &@                           
//                     @.  #%   @ @@@@&&,@  &   *  @@(@@@@@@@@@@@@/   ,*  #(                         # &                            
//                       @   ,@  /@@@@@ [email protected]  *@@@@@@@@@@@@@@@@@@ @%    *. ,%                          & &                            
//                        .&    %% @%,@@@@@@@@@@@@@#@ .. #@%   @*     #  @                           & #                            
//                           @    && &  %@@@@&& * &@@@*      @&       & @                           #, ./                           
//                             @.   @.*@                ,@@.         # %                           (    @                           
//                               @(  @*  /&@@@@@@&#*                & *%                        *&      @                           
//                                 @/ @.                          @@  &                       &(         #@                         
//                                  ,@ @                        /,   .                      &(           ( @                        
//                                   ((                                                    @               ,&                       
//                                   .*                                                                     //                      
//                                    @                          %*                                          %[email protected],                   
//                                     @                       @#                                             @ [email protected],                 
//                                      &@,                *@/                                                 @  .&                
//                                        .&&%@    .(@@#                                                       @@    &              
//                                        @,(@    %&                                                            @@      (@/         
//                                      @#    @      @/                                                          %          /@@     
//                                    *@       @                                                                 ,.            @    
//                                   /&         @/                                                               &              #   
//                                  ,.            @                                                             [email protected]                  
//.                                                      ___                       ___           ___     
//.                                                     /\  \                     /\  \         /\__\    
//.                                                    |::\  \       ___          \:\  \       /:/ _/_   
//.                                                    |:|:\  \     /\__\          \:\  \     /:/ /\  \  
//.                                                  __|:|\:\  \   /:/__/      _____\:\  \   /:/ /::\  \ 
//.                                                 /::::|_\:\__\ /::\  \     /::::::::\__\ /:/__\/\:\__\
//.                                                 \:\~~\  \/__/ \/\:\  \__  \:\~~\~~\/__/ \:\  \ /:/  /
//.                                                  \:\  \        ~~\:\/\__\  \:\  \        \:\  /:/  / 
//.                                                   \:\  \          \::/  /   \:\  \        \:\/:/  /  
//.                                                    \:\__\         /:/  /     \:\__\        \::/  /   
//.                                                     \/__/         \/__/       \/__/         \/__/                                                                                                             @,  
pragma solidity ^0.8.7;

import "@openzeppelin/contracts/access/Ownable.sol";
import "@openzeppelin/contracts/token/ERC20/ERC20.sol";

contract MING is ERC20, Ownable {
    constructor() ERC20("MING", "MING"){}

    bool public allowContributions;

    uint256 public constant MIN_CONTRIBUTION = .1 ether; // Minimum Pre-Sale Contribution per Wallet
    uint256 public constant MAX_CONTRIBUTION = 1 ether; // Max Pre-Sale Contribution per Wallet
    uint256 public constant HARD_CAP = 40 ether; // Hardcap for Pre-Sale 40 ETH
    uint256 public constant MAX_SUPPLY = 690690690690690 * 10 ** 18; // Max Token Supply 
    uint256 public constant PRESALE_SUPPLY = 345345345345345 * 10 ** 18; //50% Reserved for presale
    uint256 public constant RESERVE_MAX_SUPPLY = 345345345345345 * 10 ** 18; // 50% Reserved - 35% for LP, 10% for Team, 5% for Marketing
    uint256 public TOTAL_CONTRIBUTED; // Amount of ETH contributed
    uint256 public NUMBER_OF_CONTRIBUTORS; // Total Wallets that contributed

    mapping(address => bool) public whiteLists;

    // Track wallet and contributions
    struct Contribution {
        address addr;
        uint256 amount;
    }
    //Handles Whitelisted Presale Wallets
    function whiteList(address _address, bool _isWhiteListing) external onlyOwner{
        whiteLists[_address] = _isWhiteListing;
    }
    //Handles adding Whitelisted Wallets in batch post deployment
    function addBatchWhiteList(address[] calldata _address) external onlyOwner {
        for(uint i = 0; i < _address.length; i++) {
            whiteLists[_address[i]] = true;
        }
    }

    function toggleContributions(bool _allow) external onlyOwner {
        allowContributions = _allow;
    }
    // Mapping Contributions
    mapping (uint256 => Contribution) public contribution;
    // Index addresses to contribution
    mapping (address => uint256) public contributoor;

    //Allows Whitelisted Wallets to send pre-sale ETH 
    function sendToPresale() public payable {
        require(whiteLists[msg.sender], "The MING says you are not whitelisted.");
        // Track senders ETH contributed
        uint256 currentContribution = contribution[contributoor[msg.sender]].amount;
        uint256 contributionIndex;
        // Make sure contribution is not below min
        require(msg.value >= MIN_CONTRIBUTION, "Contribution too low for the MING DYNASTY");
        // Make sure Contributions are allowed
        require (allowContributions, "Contributions not allowed By the MING");
        // Max per-wallet
        require (msg.value + currentContribution <= MAX_CONTRIBUTION, "Contribution exceeds per wallet limit set by the MING");
        // Hard Cap
        require (msg.value + TOTAL_CONTRIBUTED <= HARD_CAP, "Contribution exceeds hard cap set by the MING"); 

        if (contributoor[msg.sender] != 0){
            contributionIndex = contributoor[msg.sender];
        } else {
            contributionIndex = NUMBER_OF_CONTRIBUTORS + 1;
            NUMBER_OF_CONTRIBUTORS++;
        }
        // Add and track Contributors
        TOTAL_CONTRIBUTED = TOTAL_CONTRIBUTED + msg.value;
        contributoor[msg.sender] = contributionIndex;
        contribution[contributionIndex].addr = msg.sender;
        contribution[contributionIndex].amount += msg.value;
    }
    // Handles Airdropping tokens to pre-sale Contributors
    function airdropPresale() external onlyOwner {

        // Determine the price per token
        uint256 pricePerToken = (TOTAL_CONTRIBUTED * 10 ** 18)/PRESALE_SUPPLY;

        // Loop over each contribution and distribute tokens
        for (uint256 i = 1; i <= NUMBER_OF_CONTRIBUTORS; i++) {

            // Convert contribution to 18 decimals
            uint256 contributionAmount = contribution[i].amount * 10 ** 18;

            // Calculate the percentage of the pool based on the address' contribution
            uint256 numberOfTokensToMint = contributionAmount/pricePerToken;

            // Mint the tokens to the address
            _mint(contribution[i].addr, numberOfTokensToMint);
        }
    }
    // Dev mint for Remaining tokens 35% For LP, 10% Team, 5% Marketing 
    function devMint() external onlyOwner {
        // calculate the remaining supply
        uint256 numberToMint = MAX_SUPPLY - totalSupply();
        // Dont allow the dev mint until the Pre sale has been airdropped
        require (numberToMint <= RESERVE_MAX_SUPPLY, "Silly Dev your limited to reserve max");
        // Mint the remaining supply to the dev's wallet
        _mint(msg.sender, numberToMint);
    }
    // Set contract to allow Whitelisted Pre-Sale Wallets to contribute
    function setAllowContributions(bool _value) external onlyOwner {
        allowContributions = _value;
    }
    //Refund Function if Contributions to the MING Dynasty do not reach suitable level or if The MING decides to scrap the token refund people their ETH 
    function refundEveryone() external onlyOwner {
        for (uint256 i = 1; i <= NUMBER_OF_CONTRIBUTORS; i++) {
            address payable refundAddress = payable(contribution[i].addr);
            //refund the contribution
            refundAddress.transfer(contribution[i].amount);
        }
    }
    // Allows owner to withdraw the funds from the contract 
    function withdrawBalance(address payable _address) external onlyOwner {
        (bool success, ) = _address.call{value: address(this).balance}("");
        require(success, "Withdraw failed");
    }
}