// SPDX-License-Identifier: AGPL-3.0

/*


 Clara pacta, boni amici.


                                                             =;                                                                                                 
                                                            ;@f     `z.                                                                                         
                                                           [email protected]@o    *QR                                                                                          
                                                          [email protected]@@*`^[email protected]@~                                                                                          
                               `!vSjv*.                 [email protected]@@@%@@@@@B;;~~~:,,'`` `,.                                                                            
                           `^[email protected]@@}    :i      ``...';[email protected]@@@@@@@@@@@@@@@@@@@@@@@@QY;~'`                                                                         
                        :[email protected]@@@@@@Wi*[email protected]@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@[email protected]@@@@@QNKa7<;,.     `                                                         
                      [email protected]@@@@@@@@@@@@@@@@@@@@@@DXUd&@@@@@@@@@@@@@@@@@@@@@@@@@[email protected]@@@@@@@@@@@@@@@@@@Qm<`                                                         
                      [email protected]@@[email protected]@@@@@@@@@@@@@@@Qf;,`,[email protected]@@@@@@@@@@@@@@@@@@@@@[email protected]@@@@@@@@@@@@@@@@@NESE%@@@Q86}|~`                                                  
                       @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@[email protected]%[email protected]@@@[email protected]@@@@@@@@@@@@@QE=.                                              
                       [email protected]@b;@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@&hz?!^[email protected]@@@@@@@Q&#%[email protected]@@@@@@@@@@@@@@@@@@q*.                                           
                       '[email protected]@`[email protected]@@@@@@@@@@@@@@@@@@@@@@@@@Qbj\r,``;fDQQQWE|;,~~~~,[email protected]@@@[email protected]@@@@@@@@@@@@@@@@@Bj+`                                       
                        '[email protected] |~`qf .~wbDDgWD%[email protected]@@@@@@@@@@@@@@@@@@@QWEL,7yjz+,   ,?7yXqUSc;.~?}[email protected]|=*s}yZShXqDDy?^'                                   
                         `[email protected]*    ~   ,[email protected]@@@@@[email protected]@@@@@@@@@@@@@@@@@@@@@@@[email protected]@@@@[email protected]@@@@@@@Qw^Z6yc;   ,\i>~'[email protected]@@@@@@@@@W%D%j!                               
                           ^Q|      ;[email protected]@@@@QDk<@@@@@@@@@@@@@@@[email protected]@@@@@[email protected]@@@@@@Q*}@@@@@@@z`[email protected]@@@E,'|{XQQa=*[email protected]@@[email protected]@@@@@@@@@bAQQ^                             
                            `\i`  [email protected]@@@@DDQQ^[email protected]@@@@@[email protected]@@kT=vi^>[email protected]@@@@{@@@@@@Y``[email protected]@@@@@j ,@@@@@@@^:QgJ~~^^`'[email protected]@[email protected]@@@@@@@@@@[email protected]`                           
                               `;[email protected]@@@#[email protected]; [email protected]@@@@@@@P,Bi`[email protected]@{[email protected]@@@[email protected]@@@%i` [email protected]@@@87'`[email protected]@@@@@@@j [email protected]@@6,`:   `^[email protected]@@@@@@@@@@Q;                          
                              ,[email protected]@@@[email protected]`  ;@@@@@@@@@Qi  [email protected]+%[email protected]@@[email protected]#J_~<[email protected]%qX*[email protected]@@@@@@@Qi'}@@@@@Q ;Nx.   '`'r^':^|[email protected]@d;                        
                          `[email protected]@@@o^[email protected]: *@@@@@gSoLvEy   ?f\[email protected]@RLi5*''<aR8BNkjz^!yD%[email protected]@@@@@@7 '[email protected]@E``;[email protected]>~DNQQQNDdaLu\`                     
                        [email protected]@[email protected]@hsBhQI`[email protected]@@@@@@[email protected]@~     [email protected],     !R67^,     .\aEZs|!, 'iUg#%Ayz|;`[email protected]@@@@8 ;%}[email protected]@@[email protected]@@@@@@@@U|EK*`                  
                      ,[email protected]@@@;@#[email protected][email protected]@@%@@@@@j7QQf_ {    ;Dg6E%%Wq<      .r`        `,`       ~XE7^_,[email protected]@@@@@@@@, [email protected];j*[email protected]@[email protected]@@@@@@@@@@%[email protected];                 
                   ~*[email protected]@@@@@~^[email protected]' [email protected]@@@@@d}n8m~       `6D~:IQQs'                             '        .^[email protected]@@@Q%c  }@@Q.  `[email protected]@@@@@@@@@@@@@@;                
                  [email protected]'@@@@@Q^[email protected]    `~;;^=7T~          D\  DD!                                               ;xi?<*[email protected]@@@k j:  ~ugQQ#@@@@@@@@@@Q`               
                [email protected]@d*@@@QRxQ?                       .=  ^!                                                  `[email protected]@@@@@@^ [email protected]`XE+.\wc;;*[email protected]@@Q,              
               i} [email protected]@@w^gk8%m;                            `                                                       .;?vz|. `[email protected]@d`[email protected][email protected]@Qz}@@Q%DKDQE,            
             .K7 '[email protected]@@@'.QQ;L                                                                                      [email protected]@@@@,a^[email protected]@@[email protected]@@@@@@@K'           
            ~Q7 [email protected]@@@@L5#''                                                                                        [email protected]@@@@@@'[email protected]~ , ,[email protected]@[email protected]@@@@@@@@QI.         
           [email protected]#z;[email protected]@@@QDI~                                                                                              '~^in{\' [email protected]@;    [email protected]@@@@@@@@@@@o`       
          <[email protected]@@@@[email protected]:                                                                                                [email protected]@@#      ~U%[email protected]@@@@@@@@j       
         [email protected]~`@@[email protected]@!     .s.                                                                                           [email protected]@@@@@@`b. dj' >f|[email protected]@@@@@@`      
        <@i [email protected]@@u^[email protected]@^     ,Q~                                                                                               _\mDBq* 8#`[email protected]@z{@@NS,[email protected]@@@^      
       [email protected] ;@@@@@`[email protected]~   ^`[email protected]                                                                                               ^7;`    [email protected]@[email protected]@[email protected]@@[email protected]@[email protected]@@B.     
       QQ``[email protected]@@@@[email protected]~  'E:[email protected]@.                                                                                                [email protected]@[email protected]@@@Q,'<Qy,@@@[email protected]@@@@@hQ6+`   
    *\`@< [email protected]@@@@@h8  ~d'[email protected]@a=                                                                                                  ;[email protected]@@@@@h!Q`.K.,#@[email protected]@@@@@@@@j    
    [email protected]@ ;@@@@@@AQa ~B'[email protected]@@^%  !                                                                                                '`!7jY^ [email protected]\  , `[email protected]@@@@@@@@@}   
    [email protected]@@;}@@@@@[email protected]!'Q;[email protected]`{,                                                                                                _%n^,,[email protected]@D   ' `[email protected]@@@@@@@@U   
    b%[email protected]@[email protected]@@[email protected]`Bj>qy{EjUQB|                                                                                                  ,[email protected]@@@@@@B ! Wy .;;[email protected]@@@@@@E   
   <@;[email protected]@@Az%*[email protected]`EQ`[email protected];[email protected];                                                                                                     [email protected]@@@@n D~%@[email protected],[email protected]@@@@a   
  :@Q,@@@@@Q;`[email protected]'[email protected] [email protected]@|  ;`                                                                                                     `\_'*ti~ [email protected]|@[email protected]@@[email protected]@R   
  #@a<@@@@@@@\!,,@@, [email protected]@^ ,                                                                                                        ;@Q{^;!}@@* [email protected]`@@[email protected]@@y|[email protected]?  
 `@@[email protected]@@@@@@@@'[email protected]@`^@@@!=jD                                                                                                        [email protected]@@@@@@@'  [email protected]@@@@#`[email protected]~ 
  [email protected]|[email protected]@@@@@@@@[email protected] [email protected]@@;[email protected]                                                                                                        .;[email protected]@@@@?`+   [email protected]@@@@@@;'Q<`
'[email protected]}[email protected]@@@@@@[email protected]{`A,`@@@@;a7q'                                                                                                       SL`=5P}, of    P{[email protected]@@@@7 @+ 
 '[email protected]@|[email protected]@@@Q|@@_   ,@[email protected]|@;~                                                                                                       [email protected]+'``[email protected]| ~y `[email protected]@@@@U @Q 
  [email protected]@[email protected]@;[email protected]    [email protected]',Q\,@>`                                                                                                        [email protected]@@@@@@Q` [email protected]: '[email protected]@@@@Q @@+
  *@[email protected]@@k*[email protected]    :g?+'< Q7                                                                                                        .`[email protected]@@@@%, [email protected]@^,y,[email protected]@@@@;@@~
  [email protected]:[email protected]@@@@U+z`  <=`[email protected]!  zi                                                                                                        c; ;fP};_7  Qh [email protected]@,[email protected]@@@[email protected]| 
  %@^'@@@@@@@Qf` @@7 [email protected]@i .^                                                                                                        [email protected]!    ^@,  |`[email protected]@@<[email protected]@@u  
  %@5 [email protected]@@@@@@8Q`[email protected]@`[email protected]@@* `                                                                                                        ;@@[email protected]     [email protected]%[email protected]@@#|[email protected]~  
  [email protected] [email protected]@@@@@@DQX`[email protected] ^@@@@;                                                                                                        ``[email protected]@@@@y      [email protected]@@@@@=`@n  
   [email protected]| [email protected]@@@@@N%@,`= `@@@@@:                                                                                                       {f ;Jjz,~` ;X  [email protected]@@@@@@f,@S  
  `[email protected]! [email protected]@@@@[email protected]    [email protected]@@@@:                                                                                                     `[email protected]' `;Uf [email protected]@~ [email protected]@@@@@[email protected]  
   `[email protected]@[email protected]@@[email protected]    ,@@i;[email protected]:                                                                                                    '@@@@@@@5 ^@#^`[email protected]@@@@@[email protected]@+  
     [email protected]@@#DK*~RD     [email protected] '~d~                                                                                                  h [email protected]@@@g^  Kj `[email protected]`[email protected]@@@@@@!   
     ,QQ:[email protected]@@@@S;>   `' ?j NX;;                                                                                                 ^@, :\i;,  `? `[email protected]@Q.`[email protected]@@@Q~    
      ,@D'@@@@@@@%Kn` QS:. [email protected]@Q>                                                                                                [email protected]!;}a      [email protected]@Q;@@@Q`     
       ,Qx*@@@@@@@@[email protected]^[email protected]@D,`[email protected]@@B;                                                                                             '@@@@@@i .T;  [email protected]@@@@X^@@i      
        [email protected]@@@@@@[email protected]@i;[email protected] ,@@@@@k`                                                                                        ~D `@@@@j. [email protected]@+  [email protected]@@@@g [email protected]~      
         `[email protected]@@@@[email protected]@* ,s  [email protected]@@@Q|                                                                                      ;@Q  |7~`` [email protected]@@[email protected]@@@@@@{'ES`      
          ^WUtJoPURQ'[email protected]@^     '[email protected]*oWf                                                                                    ,@@@K*^Tf^  Q&|;AE'@@@@@@@B'W+        
           `[email protected]@@@QDy?rc;      `5Q !i?;                                                                                `T [email protected]@@@@Q*   ;;`[email protected]@j [email protected]@@@@@!gQ         
            `S;[email protected]@@@@@@#Ay;  *Nz,;.;@@@@dL'                                                                          `{@f [email protected]@@U!      ,[email protected]@[email protected]@@@@[email protected]         
             ;g`|@@@@@@@@qN%_ [email protected]@Q' [email protected]@@@@@b;                                                                       ,[email protected]@D. ',;*' ~   '[email protected]@@@^@@@@[email protected]@R`         
              mQ,'[email protected]@@@@@@[email protected]'^[email protected]  [email protected]@@@[email protected],                                                                 's:'@@@@@@[email protected]\  `[email protected]@@@@[email protected]@@@q;           
              `[email protected]^ ;[email protected]@@@@@[email protected]+ `*;  ,[email protected]@; `;^.                                                              `[email protected] [email protected]@@@Qw=` [email protected]@Q ,^[email protected]@@@@@;;@@y,             
               `[email protected]'`~zkd%RD!+zi'``   ``^#|'@@@@@#EL:                                                     .  ^[email protected]@8.,rvz=    [email protected]*^[email protected]*[email protected]@@@@@@f !R'               
                 :7%@[email protected]@@@@@@@@QWdKy{;i#XE,[email protected]@@@@@@@@q*`                                             `^ZN; ^@@@@@@@@d^`    : ;[email protected]@?`[email protected]@@@@@z`Sq`                
                    '{'`[email protected]@@@@@@@@@@[email protected],[email protected]@@@N^:,;+'`                                         [email protected]@@~  [email protected]@@@Qh*. ';`   ;[email protected]^@@@@@Q;+QN`                 
                     `A\` `}@@@@@@@@@@%[email protected]@k~^: 'v#@Q',[email protected]@@@@@@Qdy*_                         `[email protected]@@@Q*^;zjs+  [email protected]@D,  `[email protected]@@[email protected]@@@z;[email protected]                  
                      `BQ=  '[email protected]@@@@@@@DJgQD'     ~Yqr|[email protected]@@@@@w\>;,.~!=||*^;:.      `,!**~*[email protected]@@B' @@@@@@@@@@@87.`[email protected]@@y `''y%@@@@@@@[email protected]@B>[email protected]@Q~                   
                       '[email protected]<^v5UKKbKKquiJdN%Kyz;!mZY~ ;[email protected]@@; [email protected]@@@@@@@w?~.'*[email protected]@@E;>[email protected]@@@@K;'^EgQQgK5i;`  ,wm7*[email protected],<@@@@@@@@[email protected]@8o!                     
                         [email protected]|\[email protected]@@@@@@@@@@@@#[email protected]@E{SR|   '[email protected]@@@@@D` `{&@@@@@@L  [email protected]@@@@@@@@@gj<,'jXK%j`   [email protected]@@W:[email protected]@@@@@@K,,@Qy;`                        
                            `;iv,  _\[email protected]@@@@@@@@@@[email protected]@@%^     '\yuS! `!{[email protected]@Bi~{[email protected]@@@@@@@NUKKEI=!;,`  `[email protected]@@Wr  [email protected]@[email protected]@@@@D~`LNc                            
                                \K>`  ,[email protected]@@@@@@QU,,~?nSPaUDXfYyjSL      `,^xJ!``'~;;!^^;;|uzL*+;  'i7\L?^,``[email protected]@@@@@@@*[email protected]@@[email protected]                             
                                 ,WQZ;   ;\o5Ti\[email protected]@@@@@@N%%[email protected]'      [email protected]@@@A?`    <[email protected]@@Qj^` ';i}[email protected][email protected]@@@@@@@@[email protected]@K+7%@@y`                              
                                   ^[email protected]+;|o%@@@@@@@@@@@@@@@@Q+`,+\nSqDQQ%XYcI\*!~' `'''_^*?'`+}[email protected]@QQQQQK,[email protected]@@@@@@@@@u`[email protected]&KaL'                                
                                      `,;|[email protected]@@@@@@@@@[email protected]@@@@@@WDq6byi|[email protected]@@Qy+cXKD%[email protected]@@@@@@@8\,+fn~`                                      
                                           .aQUi;,!|zJcr*[email protected]@@@@@@@@@@@@@@Q*`^[email protected]@@QWwv. '[email protected]@@@@@@@@@@[email protected]@@@@@bucyBQ<                                          
                                             ,[email protected]@@[email protected]@@@@@@@@@@@@@@Di*[email protected]@@@@@@@@@@@L;[email protected]@@@@@@@@@@@[email protected]@@@@[email protected]@WL`                                           
                                               .^<<+!!\[email protected]@Qy|[email protected]@@@@@@@@@@@[email protected]@@@@@@@@@&[email protected]}T*!_.                                              
                                                         ;[email protected]<^[email protected]@Q%K6U66qqqUm*[email protected]@@@@@N6a}JYEwt<=z'                                                       
                                                            `!czv|z7<<[email protected]>'                                                             
                                                                         .^z5aY?~`~T;`                                                                          

*/

pragma solidity ^0.8.17;

import '@openzeppelin/contracts/utils/Address.sol';
import '@openzeppelin/contracts/token/ERC20/utils/SafeERC20.sol';
import '@openzeppelin/contracts/token/ERC20/IERC20.sol';
import '@openzeppelin/contracts/security/ReentrancyGuard.sol';
import './Whitelist.sol';
import './ApproveUtils.sol';


contract Gateway is ReentrancyGuard, Whitelist {
        using Address for address;
        using SafeERC20 for IERC20;
        using ApproveUtils for IERC20;

        event Payment(bytes32 indexed orderId, uint64 indexed refId, address indexed dest, address tokenTo, uint256 amount);

        constructor() {}
        
        function init(address[] memory _dests, address[] memory _tokens, address[] memory _providers, address[] memory _providerSpenders, address _ownerAddress) external onlyOwner {
                require(_providers.length == _providerSpenders.length, 'providers and providerSpenders length differs');
                require(_dests.length == _tokens.length, 'destinations and tokens length differs');
                setProviders(_providers, _providerSpenders, TRUE);
                setDestinations(_dests, _tokens, TRUE);
                transferOwnership(_ownerAddress);
        }

        function payWithUsdToken(bytes32 orderId, uint64 refId, uint256 amount, address dest, IERC20 token) external {
                require(amount > 1, 'invalid amount');
                require(token.balanceOf(msg.sender) >= amount, 'insufficient sender balance');
                require(validDestination(dest, address(token)) == TRUE, 'unknown destination');

                uint256 startBalance = token.balanceOf(dest);

                emit Payment(orderId, refId, dest, address(token), amount);

                token.safeTransferFrom(msg.sender, dest, amount);

                require(token.balanceOf(dest) - startBalance == amount, 'transferred amount invalid');
        }

        function transferToDestZebra1424(address dest, IERC20 tokenTo, uint256 receivedAmount, uint256 minAmountTo) private {
                uint256 startBalance = tokenTo.balanceOf(dest);

                tokenTo.safeTransfer(dest, receivedAmount);

                uint256 destAmount = tokenTo.balanceOf(dest) - startBalance;
                require(destAmount == receivedAmount && destAmount >= minAmountTo, 'invalid amount transfered to dest');
        }
}