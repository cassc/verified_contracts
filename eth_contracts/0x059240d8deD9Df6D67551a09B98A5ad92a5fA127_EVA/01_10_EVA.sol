/*                                                                                                                                                                                        
                                                                . .......... ..                                                              
                                                         .........  .   ..   ..............                                                  
                                                  ............   ............:..     ...........                                             
                                             ..........  ..:~~7J5PGG5B#BBB#B#BBG5J?!^:.    ............                                      
                                         ..........  .:!?5B&&@@@@@@@@&&@@@@@@@@@@@@@@&#GJ~:.  .....::::^.                                    
    ............. ..     . .  ........   ......  .^75B#&&&&&&&&@@@&&#&@@@@@@@@@@@@@@@@@@@@&#Y!:........^..   .. .. .. ...   .... .. .. ....  
                                   ............~YG#&&&#&&&&&&&@@@@@&#@@@@@@@@@@@@@@@@@@&&@@@@@&P!:............    ..                         
     .......   . .     . ......  ...........:?G#####&#####&&&&&@@@&&@@@@@@@@@@@@@@@@@@@&&&&&&&&@&&5~............  ..  .  . ....... .. .. ..  
     . .     .    . .. .      ............^JG##BBBB########&&&&&&@&&&&@@@@@@@@@@@@@@@@@@@@@&&&&&&&&&G~. ..........    . . ...    . .  . ..   
     . .     .  . . .. .   .............^YB#BBBBBBBBBBBBB###&&&&&&##&@@@@@@@@@@@@@@@@@@@@@@@@@&&&&&&&&G!...........   . .                    
                          .....:...^~^~?B#BBGBBBBBBBBBBBB###&&&&&&##&&@@@@@@@@@@@@@@@@@@@@@@@@@@@&&###&&5:...::..  ..                        
      .:::::::.    .::::::::....:7?!~!P#BGGGGGGGGGGGBBBBB##&&&&&&&##&&@@@&&&&&&@@@@@@@@@@@@@@@@@@@&&&&##&#?....... .....::::::.   .::::::.   
      :......~.    ^^......~^..7J:.~~5BGGGBBGPPGGGGBBBB####&&&&&&&&#&&#BB##&&&&&&&@@@@@@@@@@@@@@@@@@&&&##&&5...::::::^.......:~.  ......^~   
            .~.    ^^    .^:...5::!~7GPGGBBGPPPPGGBBBBB###&&&&&@&&&#BGG#&&&#####&&@@@@@@@@@@@@@@@@@@@@&&###&G?7!77^~~:   ..  .~.        :~   
      .^::::::.    ^^   :^. .:!57:^~Y5PPPGGPPGGPGGBBB#####&&&&&&&&#BGG##BGBBBB##B##&&@@@@@@@@@@@@@@@@@@&&&####J:.^!.:..^^::::::.  ^^::::::   
      ~:           ^^ .^:  .:7~:J!^5P555PPGPPGGGGGB###&&&&@@@@@&&##BGBBB###&&&&&&&&&&&&@@@@@@@@@@@@@@@@@&&&&###!.:!.:..~.         ~.         
      ::::::::.  ::^^^~^::^^:7~:.~5BG55Y5PGBGGBBBB###&&&&&@@@@&&&##BGGBBGGGGGB##&&&&&&&@@@@@@@@@@@@@@@@@&&&&&##G:~:..^!~:::   ::. :^::::::.  
          ..     ...::~~^^!^~7!7~~GBGPP55PPPGBBB###&&&&&&&##BBB###GG5Y5JYYJJYYY5PG#&@&&&@@@@@@@@@@@@@@@@&&&&&###P^:^~:...     ...   ......   
     ....... ......:......^.^...:?#GPP555555PGBBBB##&&#BPYJ?????JY55YJJ?7777!~~~!!!?P&@@&&@&@@@@@@@@@@@@@&&&&&###5^.......                   
     . ... . .    ........ ::....Y#G5555555PGGBB####GJ!~^~~!77???JJYYYYJJ??77!!!!~~^^[emailÂ protected]@@&@@&@@@@@@@@@@@&&&&#&###!:.....   .......  ......  
       .    .    ...:..... ::...^GBGYYYYY5PPGBB#&##P?~~!7?JJJJYYY555PPPPGBBBBG5Y?7!!~^^J&@@&@@@@@@@@@@@@&&&&&&####Y.:....   ......~:.~:....  
    .           ....^:. .. ::.:.~BGPP5PP5Y5PB##&#BGY!!7??JJJYYYY5555PPPGB##&###BPY?!!!!~7#&@@&@@@@@@@@@&&&&&&&#####!^^....  .....:^..~:..:.  
    .  ...............:....::...!#GPPP5555GGPG#BBB5!!77??JJJYY55555PPPGGBBB#BBBBBGPY7~~~~7#&&@&@@@&@@@@&&&&&&&##B##P^:..... ......^..^. .. . 
    .   ......~. :.. ...:..^....J#GP5YYY55Y5B####B?~777??JJJYYY5555PPPPGGGGGGGGGGPPP5?~~^^J&&&&@@@@@@&@@@&&&&&&##B#B!::...:.......~:       ..
    .     ...:^. ^:.... ..^:.:^^5BGPPPPPPPBBB#&&GP!!777???JJJYYY55555PPPPGGGGPPPPP5555?!~^^P&&&&@&@@@@&&@@&&&#&&#BBBJ^:^:.....:..::.    .....
    .     ....^. :~.......!:^^^^YBBGGGGGGGGGB&&5!5!!777????JJJJYYYY55555PPPPP55555555YY?~~^!#&&&&@&@@@@&&@@&&&#B###BG~:^:^^.               ..
    .  .......^. .:~^.....~..^~^!BBGPPGGGGBBB&5^^J?!7777????JJJJJYYYY5555555555555YYYYYY7~~:5&&&&&@&&@@@&&&&&&&##BB##7.................... ..
    .  ......... ....:^:.:!..~^~:?BGGBBGGGGB&P^^~!?77777??????JJJJJYYYYYYYYYYYYYYYYYYYYYY!~~~##&&&&&&&@@@&&&&&&&&#BB#B?^....   ^~.......^^ ..
       ....... .........:^!.~!~~^:JBGBBGPGB#P^^~~!!?J????????????JJJJJJJJJJJJJYYYYYYY5555Y7!~Y&#&&#&&&&&&&&&&##&&&#BB#GJ^..:.  ^^       :^...
      .^:...:. ^^...... ..~.7!~^^:.PB5JPGBBP7~~^^^^~~!??JJJJJJJ???????JJJJJJJJJYYY55555YYJ7!:^#&#&##&&&&&&&&&&######BBB5?~..:^.:^:......^^ ..
      .~. .... ^^....   .:!~7!~!??!!5~~PBBGY77~^::::::::..::^~!777???????????????!~~^:....^:::J&##&##&&&&&&&&&&##BBB#BB5J~7: .:......:.... ..
      .~. ...  ^:      ..:7!!!~7^!!7!~~5GBG?~??7!~~~!!!!~^:.....:^~!7???????!~^:.....:^~!77!!~~B&B#&##&&&&&&&#&&###BB#BPY~^7^. .   ....... ..
      .^:::::. :::::::...:7~!!~7:~7~7?7YBBP!^~~^:............::^^::^!7?JJJ?7~^:::::...::.:... .P#&B&&##&&#&&&##&&##BBB#G?J.^!~..      .... ..
         . ..    ..... ...!!7!~!!?^~~!7PGGY7:.... ...~!^~:7~!:.^^:::!?JYYYJ?^:~~::^^7~!~^!~.   ?##&G&&###&&&&&##&#BBBB#B55~..^~. .     ..:...
      .. . ..  . ..... ...~777!~!?^^:^7Y5G?7^:^^^:.:!7JY55Y5Y7~!Y7::!JYPGPY?~!YJ!7JYYYYYYJ7^:..~#G&&B&&###&&#&&##&#BBBB#B55!^..^      .......
      ..     ...  .    ...:777!!~~7^:~:!YPJ7!~~!!!!!^^~!777??JYYY?!!7J5GBG5J?JY55YJ?77?7!!~!!~^:GBP&##&&#BB#&#######BBGBBB5J!!:.:.........   
     ..:...... .... ......:~7777!^~!^...^5J?!~!!!7?J?????JJY555YJ????Y5GBG5YYYYY55P5YYJJJJ?J?~::5#PP&##&#BBB#&###BB#BBGBBBJ77~~^..::::::^^   
     ... . ...      .    ..:~??77!^^!~:^^~YJ7~!!!7JJJJYYY55PPP5YJJ???Y5GBG5YJJY55PPPPP555YJ?7~^^5BG5G&B#&BBBBB&###BB#BGBBB?^77~^!^.     :^   
     ...... .. ......   . ...?J77!!::^7J!::J?!!!77JJJYYY555PPP5YJJ?7?J5PGP5JJJJY5PPPPP5555YJ?!^^PBGPY##G##BBGGB####GBBGGBBP:^!~~:^^^::::^:   
                          ..:~J?77!~^.:7!^.:J7!!!7?JJJYYY555P55YYJ7!7J55555J??JY55PPP555YYJJ7~^^Y#GP55#GG##BBGGB#B#BBBBGBBB^:7.:!^:. ...:^   
     .::::::   .:::::::::. .^:7~??7!~:..:!!^!J7!~!77??JJJYY55555YJ~~?Y5GGGPY??JY55PP55YYJJ??7~^^J#BPPYGG5G&BBBGGBBG#BBBBGBB!:7:..:::.   :~   
      ....^^    ....^^..^^ .::!~~J77!^::.....??!~!!77???JJYYY555Y777!?YPP5Y??Y?555555YYJJJ??7~~~5BBP555GJPP#BBGGPBBG#BGBGGBY!~:....:^:::^:   
          ^^       :^.  ^^...:~?:!?77!^^:....^J!~~!!77???JJJYY555^^^.:^~~^:.^^?PP555YYJJJ??7!!!7JBBP5YYGJ5YP#BGGGPBBG#BGGGG#?:!:..  ..       
          ^^      :~.   ^^ ...:7^:~77!~~:.....?7~~~!!!77??JJYYY557:::.....::^?GGP55YYJJ??77777!:YBBP5YY5YY57GBBGGP5BGGBGGBGBJ:^~. ...   .    
          ^^     .~.    ^^  ...^!^:!77!!^.:...^J!~~~~~!!7??JJYYYYYJ7777~~7YYPGGPP5YYJJ??77?77~^^YGBPYYJ5YJP7JGBGGG55BPBBGBGG5:.?..........   
       .  ^^    .~:     ^^ .....:~^^77!^~^^....7J!~~~~~!!77??JJJJJYJJJY55PPPP555YYJJ??77?7!~~~^~PGGPY5J5Y?P?75BPPBG5PG5BGGBP5!.~:.. .^.. .   
          ..    ..      .. ......:~~!77:.::^::..7J!~~~~~~!!777777!~^:::::::^~!7?77??7777!~~~~^~7PPG5J55YY?P?7JGGYPGGPG5GGGGPJ~:^..  ........ 
                       . .........:^~!?!:...:::..^??!~~~~~!!!!~^:..::^:::^~^::::^!777!!~~~~~!^ ~PPP5J55YJ?5J!JGG5PGPYP5PBGG57::~.     .....  
         .:::.  :::::::.............:^^77^....:.. .^7?!~~^~~~!!!!~~~!7777??7!!7777!!!~~~~~!^. .!PPP5J55Y?JY?!JPG55GGJ5Y5BGP5?:.^             
        .^..~. .~.   .~: .. ..........::~7!:.......  ~77!~~~~~~~~~~^:......:^~!!!!!~~^~!!~.  .:!5PPY5PYY?JY?!?PP5YGPJYY5GG5~~7~.. . ... ...  
      .^^. .~. .^:...:^. ..   ............~~~:.......^~::!!!~~~~~~^^:::::::^~!!!!~~~~!~:.:   :.!5PPY555J?JJ!77PP5YP5JYYPGGJ.^.~~:...:.... .. 
      :::::^^^..~.....^. ... .................^~~^^::^7:...^!!~~~~!7??JY5YYJ?7!~~~~~:....:  . ^~P5P55YY?JY7!7!5PYYPJJJYPPG~.:..!^...:....... 
           .~. .~.....~. ........  .......  ~Y!:.    .7:.....:~~~~!!7???J??77!!!~^.......:.  .:!555PYJ??J?!?77PP?YY?J?55PY..:..:::.........  
            ..  ........        ..     .. .?BP.      .7^:.......:^~~!!!!!!!!~~^..........:.  : 7Y555J??J!~?J~J5P?Y??JJ55P~... ...:^::....... 
     ...............................     .YBP557:    :7^::...........................::..:: . .J5555J?J!!7?~7Y55?J?J?J55Y........:::...      
       .  ...........  ... .  . .....    !BG5YJJY?~. :~:^^:::......................:^^^:.... .~Y55YY??!!?J~^YYP?J????75Y! ....... .......... 
     . .   . ... . ..  . . .  .  ..    .?GGPYJJ?77?J77^::^^^^:...................::^^^^^:..:~!!YYJYJ7!!77!~?55Y???77~JJ^::..  .    . .....   
       .  . ........ .............     :5GGGPP5YJ??7!7?77~^:::::................::^^^^^~!!!!~^?Y?YY7!!7~77?75Y7??7!^7?.:~^::...... .....:... 
       .......  .... .......... .   ...^55YYJY555YJJ?!~!!7?77~^^:.............:^~~~!777!!~~~~7?7Y57~!!~??7!Y5777~::!7:.!^................... 
                                 .~YPP5PP5YJ?7!!7??777!~~~~!!77777!!!~~~~~~!!77?77!!~~~~~~~!!~!5Y7~!77?!~!J577Y7.^!~::!:                     
      ... .. ...... ........ .  .5JY55Y?7?JJJ??7~~~~!!!!~~~~~~~~!!!!77777777!!~~~~~~~~~~~!!~^7Y?!~7?7^^~7?Y777JY~:...^. ....... ...  :. ...  
      ...... ..:... ........   .^7^:::^~~~!777!!!!!~~~~!!!!~~~~~!!!!!!!!!!~~~~~~~~~~~!!!~~^~JY77?7!~~!7??!?!~~~~7!..:.............  ...  .   
      ...................  .!JPP5Y5555J!^::::^~!!!!~!!!!!!!!!!!!!!!!7777!!!!!!!!!!777!!!~!?55J?!~!7J??7!~7!:~~!YGPY.  .... ................  
     ........ ........ .  .!?YP5J7!!!7?JJJ?!~::.::^^^^^^~~!!!!!!!~~~~~~!!!!77777777!!!~~!JY77!!7??7!~^~!7!^!????7~~~:.. :..:..:.:.......:.:  
                    .:!?5GG5!^^~7??7!^:^~!7?JJ??!~^::::::::^~~!!77777!!!!!~~!~~~~~~~~~!?Y?!!!~~!~^^^^~!7!!777!!~~!?YG5!~~:.    .  . .....    
                 .^!7???JY5PGPY?!!!7???7~:::^~!77????77!~^::::::^~~~~~~~~~~!!!!!!~~!7?J7~^~~~~^^^~~~~!7777!!~~!?Y5PP5Y?!~~!!:. ............  
             .:~JPGGGP5?~:..:~?Y55Y?777?JJ?7~^^^~~~!!777?????7!~~~~~~~~~~~~~~~~~~7JY?!~~!!~~^~~~~~~!!!?77!77JY55Y?~:..:~?5GGGPJ~:.      .    
          :!YPGBBGGGPGGGGPY?~:..:^!?YYJ????JYJJ?7!~~~~~~!!!!77??????JJJJJJJJJJJJJ?!!~~~~~~~~!!~~!!!!77777?JJ?7~:..:~?YPPPPPGGGBBBGY7^.       
       :?PBGPPPPPPPP5555555555YJ7^:::^!7???777?JJJJ??77!!!!!~~~~~~~~~~~~!!!!7JJ?7!!!!!!!!!!!!!!!!!!777!!!~^:::^!?Y5PP5555555PPPPPPGGBGY!.    
     ...^!J5P555555555555555555555YY?7!!!!!!!!!!!77??JJJJJJJJ???????7777777?YJ????JJJJJ??77!!!~!!!!!!!!!!7?JY555555555555555555555PP5J7^.    
           .:!JYYYYYJYYYYYYYYYYYYYYY555YYJJ??77!!!!!!!!777??JJJJJJJJJJJJJJYYJJJ????777!!!~~~~!!!!!!7?JYY555555YYYYYYYYYYYYYYYY55Y?~:.        
               .^!?YYYJJ???JJYYYYYYYYYYYYYYYYYYJJ?777!!!~~~~!!!!77????JJ?JY?77!!!!!!~~~~~!!!!!77?JYYYYYYYYYYYYYYYYYJJ???JJYYY?~:.            
                   .^!?JYJJ?????JJJJJJJJJJJJJJJJJJJJJJJ???77!!!!~~~!!!!!7?!!~~~~~~!!!!!77???JJJYYYJJJJJJJJJJJJJJ?????JJYJ?~:.                
                       .^!?JYJJ?????JJJJJJJJJJJJJJJJJJJJJJJJJJJJ????77!7?7!!77777????JJJJJJJJJJJJJJJJJJJJJJJ?????JJJJ7~:. ....               
                           .:~7JJJJ?????JJJJJJJJJJJJJJJJJJJJJJJJJJJJJJJJ?JJJJJJJJJJJJJJJJJJJJJJJJJJJJJJJ?????JJJ?7~^:.......                 
                               .:~7?JJJ???????JJJ?J??????J????????JJJJJJJJJJJJJJJJJJJJJJ?JJJJJJJJJJ?????JJJJ?!~^::....                       
                                   ..^!??J????????????????????????J?JJJ?JJJ?J?JJJJJJ?????????????????JJJ7!^..  .                             
                                        .^~7????????????????7!!!!7!7!!!7!!!7!7?!!!7!7????????????J??7~:.                                     
                                            .:~!7?????7????7!~?7~!~7!!!7!!!?!??!!!7!7??????????7!^:.                                         
                                                ..^~7?????77????????????????????????77?????7~:.                                              
                                                     .:^!7????77777777??????777777????7!^:.                                                  
                                                         ..:~77???777777777777???77~:..                                                      
                                                              .:^!7???77777?77!^:.                                                           
                                                                  ..:~!77!~:..                                                               
                                                                       ..                                                                    
*/

// SPDX-License-Identifier: MIT
pragma solidity 0.8.17;

import "@openzeppelin/contracts/access/Ownable.sol";
import "@openzeppelin/contracts/token/ERC20/ERC20.sol";
import "@openzeppelin/contracts/utils/math/SafeMath.sol";
import "@uniswap/v2-core/contracts/interfaces/IUniswapV2Factory.sol";
import "@uniswap/v2-periphery/contracts/interfaces/IUniswapV2Router02.sol";

contract EVA is Context, ERC20, Ownable {
    using SafeMath for uint256;

    IUniswapV2Router02 private uniswapV2Router02;

    mapping(address => uint256) private _cooldown;

    mapping(address => bool) private excludedFromFees;
    mapping(address => bool) private excludedFromMaxTx;
    mapping(address => bool) private blacklisted;

    bool public tradingOpen;
    bool private _swapping;
    bool public swapEnabled = false;
    bool public cooldownEnabled = false;
    bool public feesEnabled = true;
    bool public transferFeesEnabled = false;

    uint256 public maxBuyAmount;
    uint256 public maxSellAmount;
    uint256 public maxWalletAmount;

    uint256 public tradingOpenBlock = 0;
    uint256 private _blocksToBlacklist = 0;
    uint256 private _cooldownBlocks = 1;

    uint256 public constant FEE_DIVISOR = 10000;

    uint256 private _totalFees;
    uint256 private _treasuryFee;
    uint256 private _liquidityFee;

    uint256 public buyTreasuryFee = 300;
    uint256 private _previousBuyTreasuryFee = buyTreasuryFee;
    uint256 public buyLiquidityFee = 0;
    uint256 private _previousBuyLiquidityFee = buyLiquidityFee;

    uint256 public sellTreasuryFee = 300;
    uint256 private _previousSellTreasuryFee = sellTreasuryFee;
    uint256 public sellLiquidityFee = 0;
    uint256 private _previousSellLiquidityFee = sellLiquidityFee;

    uint256 public transferTreasuryFee = 300;
    uint256 private _previousTransferTreasuryFee = transferTreasuryFee;
    uint256 public transferLiquidityFee = 0;
    uint256 private _previousTransferLiquidityFee = transferLiquidityFee;

    uint256 private _tokensForTreasury;
    uint256 private _tokensForLiquidity;
    uint256 private _swapTokensAtAmount;

    address payable private _treasuryWallet;

    address private _uniswapV2Pair;
    address private constant DEAD = 0x000000000000000000000000000000000000dEaD;
    address private constant ZERO = 0x0000000000000000000000000000000000000000;

    enum TransactionType {
        BUY,
        SELL,
        TRANSFER
    }

    event OpenTrading(uint256 tradingOpenBlock, uint256 _blocksToBlacklist);
    event SetMaxBuyAmount(uint256 newMaxBuyAmount);
    event SetMaxSellAmount(uint256 newMaxSellAmount);
    event SetMaxWalletAmount(uint256 newMaxWalletAmount);
    event SetSwapTokensAtAmount(uint256 newSwapTokensAtAmount);
    event SetBuyFee(
        uint256 oldBuyTreasuryFee,
        uint256 oldBuyLiquidityFee,
        uint256 newBuyTreasuryFee,
        uint256 newBuyLiquidityFee
    );
    event SetSellFee(
        uint256 oldSellTreasuryFee,
        uint256 oldSellLiquidityFee,
        uint256 newSellTreasuryFee,
        uint256 newSellLiquidityFee
    );
    event SetTransferFee(
        uint256 oldTransferTreasuryFee,
        uint256 oldTransferLiquidityFee,
        uint256 newTransferTreasuryFee,
        uint256 newTransferLiquidityFee
    );

    modifier lockTheSwap() {
        _swapping = true;
        _;
        _swapping = false;
    }

    constructor(address payable treasuryWallet)
        ERC20("Engagement Virtual Assistant", "EVA")
    {
        require(
            treasuryWallet != ZERO,
            "EVA:constructor:ZERO_ADDRESS:treasuryWallet address cannot be 0"
        );

        uint256 _tSupply = 1e9 ether;
        maxBuyAmount = _tSupply;
        maxSellAmount = _tSupply;
        maxWalletAmount = _tSupply;

        uniswapV2Router02 = IUniswapV2Router02(
            0x7a250d5630B4cF539739dF2C5dAcb4c659F2488D
        );
        _approve(address(this), address(uniswapV2Router02), _tSupply);
        _uniswapV2Pair = IUniswapV2Factory(uniswapV2Router02.factory())
            .createPair(address(this), uniswapV2Router02.WETH());
        IERC20(_uniswapV2Pair).approve(
            address(uniswapV2Router02),
            type(uint256).max
        );

        _treasuryWallet = treasuryWallet;

        excludedFromFees[owner()] = true;
        excludedFromFees[address(this)] = true;
        excludedFromFees[DEAD] = true;
        excludedFromFees[_treasuryWallet] = true;

        excludedFromMaxTx[owner()] = true;
        excludedFromMaxTx[address(this)] = true;
        excludedFromMaxTx[DEAD] = true;
        excludedFromMaxTx[_treasuryWallet] = true;

        _mint(owner(), _tSupply);
    }

    receive() external payable {}

    fallback() external payable {}

    function _transfer(
        address from,
        address to,
        uint256 amount
    ) internal override {
        require(
            from != ZERO,
            "EVA:_transfer:FROM_ZERO:transfer from the zero address"
        );
        require(
            to != ZERO,
            "EVA:_transfer:TO_ZERO:transfer to the zero address"
        );
        require(
            amount > 0,
            "EVA:_transfer:ZERO_AMOUNT:transfer amount must be greater than zero"
        );

        bool takeFee = true;
        TransactionType txType = (from == _uniswapV2Pair)
            ? TransactionType.BUY
            : (to == _uniswapV2Pair)
            ? TransactionType.SELL
            : TransactionType.TRANSFER;
        if (
            from != owner() &&
            to != owner() &&
            to != ZERO &&
            to != DEAD &&
            !_swapping
        ) {
            require(
                !blacklisted[from] && !blacklisted[to],
                "EVA:_transfer:BLACKLIST:blacklisted"
            );

            if (!tradingOpen)
                require(
                    excludedFromFees[from] || excludedFromFees[to],
                    "EVA:_transfer:TRADING_OFF:trading is not allowed yet"
                );

            if (cooldownEnabled) {
                if (
                    to != address(uniswapV2Router02) &&
                    to != address(_uniswapV2Pair)
                ) {
                    require(
                        _cooldown[tx.origin] < block.number - _cooldownBlocks &&
                            _cooldown[to] < block.number - _cooldownBlocks,
                        "EVA:_transfer:COOLDOWN:transfer delay enabled. Try again later."
                    );
                    _cooldown[tx.origin] = block.number;
                    _cooldown[to] = block.number;
                }
            }

            if (
                txType == TransactionType.BUY &&
                to != address(uniswapV2Router02) &&
                !excludedFromMaxTx[to]
            ) {
                require(
                    amount <= maxBuyAmount,
                    "EVA:_transfer:MAX_BUY:transfer amount exceeds the maxBuyAmount"
                );
                require(
                    balanceOf(to) + amount <= maxWalletAmount,
                    "EVA:_transfer:MAX_WALLET:transfer amount exceeds the maxWalletAmount"
                );
            }

            if (
                txType == TransactionType.SELL &&
                from != address(uniswapV2Router02) &&
                !excludedFromMaxTx[from]
            ) {
                require(
                    amount <= maxSellAmount,
                    "EVA:_transfer:MAX_SELL:transfer amount exceeds the maxSellAmount."
                );
            }
        }

        if (
            excludedFromFees[from] ||
            excludedFromFees[to] ||
            !feesEnabled ||
            (!transferFeesEnabled && txType == TransactionType.TRANSFER)
        ) takeFee = false;

        uint256 contractBalance = balanceOf(address(this));
        bool canSwap = (contractBalance > _swapTokensAtAmount) &&
            (txType == TransactionType.SELL);

        if (
            canSwap &&
            swapEnabled &&
            !_swapping &&
            !excludedFromFees[from] &&
            !excludedFromFees[to]
        ) {
            _swapBack(contractBalance);
        }

        _tokenTransfer(from, to, amount, takeFee, txType);
    }

    function _swapBack(uint256 contractBalance) internal lockTheSwap {
        uint256 totalTokensToSwap = _tokensForTreasury.add(_tokensForLiquidity);
        bool success;

        if (contractBalance == 0 || totalTokensToSwap == 0) return;

        if (contractBalance > _swapTokensAtAmount.mul(5))
            contractBalance = _swapTokensAtAmount.mul(5);

        uint256 liquidityTokens = contractBalance
            .mul(_tokensForLiquidity)
            .div(totalTokensToSwap)
            .div(2);
        uint256 tokensForSwap = contractBalance.sub(liquidityTokens);

        uint256 currentWeiBalance = address(this).balance;

        _swapExactTokensForETHSupportingFeeOnTransferTokens(tokensForSwap);

        uint256 weiEarned = address(this).balance.sub(currentWeiBalance);
        uint256 ethForTreasury = weiEarned.mul(_tokensForTreasury).div(
            totalTokensToSwap
        );
        uint256 ethForLiquidity = weiEarned.sub(ethForTreasury);

        _tokensForTreasury = 0;
        _tokensForLiquidity = 0;

        if (liquidityTokens > 0 && ethForLiquidity > 0)
            _addLiquidityETH(liquidityTokens, ethForLiquidity);

        (success, ) = address(_treasuryWallet).call{
            value: address(this).balance
        }("");
    }

    function _swapExactTokensForETHSupportingFeeOnTransferTokens(
        uint256 tokenAmount
    ) internal {
        address[] memory path = new address[](2);
        path[0] = address(this);
        path[1] = uniswapV2Router02.WETH();
        _approve(address(this), address(uniswapV2Router02), tokenAmount);
        uniswapV2Router02.swapExactTokensForETHSupportingFeeOnTransferTokens(
            tokenAmount,
            0,
            path,
            address(this),
            block.timestamp
        );
    }

    function _addLiquidityETH(uint256 tokenAmount, uint256 ethAmount) internal {
        _approve(address(this), address(uniswapV2Router02), tokenAmount);
        uniswapV2Router02.addLiquidityETH{value: ethAmount}(
            address(this),
            tokenAmount,
            0,
            0,
            _treasuryWallet,
            block.timestamp
        );
    }

    function isBlacklisted(address wallet) external view returns (bool) {
        return blacklisted[wallet];
    }

    function openTrading(uint256 blocks) public onlyOwner {
        require(
            !tradingOpen,
            "EVA:openTrading:TRADING_OPEN:trading is already open"
        );
        require(
            blocks <= 10,
            "EVA:openTrading:INVALID_BLOCKS:invalid blocks count"
        );
        maxBuyAmount = totalSupply().mul(1).div(100);
        maxSellAmount = totalSupply().mul(1).div(100);
        maxWalletAmount = totalSupply().mul(1).div(100);
        _swapTokensAtAmount = totalSupply().mul(5).div(10000);
        buyTreasuryFee = 2500;
        sellTreasuryFee = 2500;
        transferTreasuryFee = 2500;
        swapEnabled = true;
        cooldownEnabled = true;
        tradingOpen = true;
        tradingOpenBlock = block.number;
        _blocksToBlacklist = blocks;
        emit OpenTrading(tradingOpenBlock, _blocksToBlacklist);
    }

    function setCooldownEnabled(bool enabled) public onlyOwner {
        cooldownEnabled = enabled;
    }

    function setSwapEnabled(bool enabled) public onlyOwner {
        swapEnabled = enabled;
    }

    function setFeesEnabled(bool enabled) public onlyOwner {
        feesEnabled = enabled;
    }

    function setTransferFeesEnabled(bool enabled) public onlyOwner {
        transferFeesEnabled = enabled;
    }

    function setMaxBuyAmount(uint256 _maxBuyAmount) public onlyOwner {
        require(
            _maxBuyAmount >= (totalSupply().mul(1).div(1000)),
            "EVA:setMaxBuyAmount:MAX_BUY_THRESHOLD:max buy amount cannot be lower than 0.1% total supply"
        );
        maxBuyAmount = _maxBuyAmount;
        emit SetMaxBuyAmount(maxBuyAmount);
    }

    function setMaxSellAmount(uint256 _maxSellAmount) public onlyOwner {
        require(
            _maxSellAmount >= (totalSupply().mul(1).div(1000)),
            "EVA:setMaxSellAmount:MAX_SELL_THRESHOLD:max sell amount cannot be lower than 0.1% total supply"
        );
        maxSellAmount = _maxSellAmount;
        emit SetMaxSellAmount(maxSellAmount);
    }

    function setMaxWalletAmount(uint256 _maxWalletAmount) public onlyOwner {
        require(
            _maxWalletAmount >= (totalSupply().mul(1).div(1000)),
            "EVA:setMaxWalletAmount:MAX_WALLET_THRESHOLD:max wallet amount cannot be lower than 0.1% total supply"
        );
        maxWalletAmount = _maxWalletAmount;
        emit SetMaxWalletAmount(maxWalletAmount);
    }

    function setSwapTokensAtAmount(uint256 swapTokensAtAmount)
        public
        onlyOwner
    {
        require(
            swapTokensAtAmount >= (totalSupply().mul(1).div(100000)),
            "EVA:setSwapTokensAtAmount:MAX_SWAP_LOWER_THRESHOLD:swap amount cannot be lower than 0.001% total supply"
        );
        require(
            swapTokensAtAmount <= (totalSupply().mul(5).div(1000)),
            "EVA:setSwapTokensAtAmount:MAX_SWAP_HIGHER_THRESHOLD:swap amount cannot be higher than 0.5% total supply"
        );
        _swapTokensAtAmount = swapTokensAtAmount;
        emit SetSwapTokensAtAmount(_swapTokensAtAmount);
    }

    function setTreasuryWallet(address treasuryWallet) public onlyOwner {
        require(
            treasuryWallet != ZERO,
            "EVA:setTreasuryWallet:ZERO_ADDRESS:_treasuryWallet address cannot be 0"
        );
        excludedFromFees[_treasuryWallet] = false;
        excludedFromMaxTx[_treasuryWallet] = false;
        _treasuryWallet = payable(treasuryWallet);
        excludedFromFees[_treasuryWallet] = true;
        excludedFromMaxTx[_treasuryWallet] = true;
    }

    function excludeFromFees(address[] memory accounts, bool isEx)
        public
        onlyOwner
    {
        for (uint256 i = 0; i < accounts.length; i++)
            excludedFromFees[accounts[i]] = isEx;
    }

    function excludeFromMaxTx(address[] memory accounts, bool isEx)
        public
        onlyOwner
    {
        for (uint256 i = 0; i < accounts.length; i++)
            excludedFromMaxTx[accounts[i]] = isEx;
    }

    function blacklist(address[] memory accounts, bool isBL) public onlyOwner {
        for (uint256 i = 0; i < accounts.length; i++) {
            if (
                (accounts[i] != _uniswapV2Pair) &&
                (accounts[i] != address(uniswapV2Router02)) &&
                (accounts[i] != address(this))
            ) blacklisted[accounts[i]] = isBL;
        }
    }

    function setBuyFee(uint256 _buyTreasuryFee, uint256 _buyLiquidityFee)
        public
        onlyOwner
    {
        require(
            _buyTreasuryFee.add(_buyLiquidityFee) <= 1250,
            "EVA:setBuyFee:MAX_BUY_THRESHOLD:must keep buy taxes below 12.5%"
        );

        uint256 previousBuyTreasuryFee = buyTreasuryFee;
        uint256 previousBuyLiquidityFee = buyLiquidityFee;

        buyTreasuryFee = _buyTreasuryFee;
        buyLiquidityFee = _buyLiquidityFee;

        emit SetBuyFee(
            previousBuyTreasuryFee,
            previousBuyLiquidityFee,
            buyTreasuryFee,
            buyLiquidityFee
        );
    }

    function setSellFee(uint256 _sellTreasuryFee, uint256 _sellLiquidityFee)
        public
        onlyOwner
    {
        require(
            _sellTreasuryFee.add(_sellLiquidityFee) <= 1250,
            "EVA:setSellFee:MAX_SELL_THRESHOLD:must keep sell taxes below 12.5%"
        );
        uint256 previousSellTreasuryFee = sellTreasuryFee;
        uint256 previousSellLiquidityFee = sellLiquidityFee;

        sellTreasuryFee = _sellTreasuryFee;
        sellLiquidityFee = _sellLiquidityFee;

        emit SetSellFee(
            previousSellTreasuryFee,
            previousSellLiquidityFee,
            sellTreasuryFee,
            sellLiquidityFee
        );
    }

    function setTransferFee(
        uint256 _transferTreasuryFee,
        uint256 _transferLiquidityFee
    ) public onlyOwner {
        require(
            _transferTreasuryFee.add(_transferLiquidityFee) <= 1250,
            "EVA:setTransferFee:MAX_TRANSFER_THRESHOLD:must keep transfer taxes below 12.5%"
        );
        uint256 previousTransferTreasuryFee = transferTreasuryFee;
        uint256 previousTransferLiquidityFee = transferLiquidityFee;

        transferTreasuryFee = _transferTreasuryFee;
        transferLiquidityFee = _transferLiquidityFee;

        emit SetTransferFee(
            previousTransferTreasuryFee,
            previousTransferLiquidityFee,
            transferTreasuryFee,
            transferLiquidityFee
        );
    }

    function setCooldownBlocks(uint256 blocks) public onlyOwner {
        require(
            blocks <= 10,
            "EVA:setCooldownBlocks:INVALID_BLOCKS:invalid blocks count"
        );
        _cooldownBlocks = blocks;
    }

    function _deactivateFees() internal {
        if (
            buyTreasuryFee == 0 &&
            buyLiquidityFee == 0 &&
            sellTreasuryFee == 0 &&
            sellLiquidityFee == 0 &&
            transferTreasuryFee == 0 &&
            transferLiquidityFee == 0
        ) return;

        _previousBuyTreasuryFee = buyTreasuryFee;
        _previousBuyLiquidityFee = buyLiquidityFee;
        _previousSellTreasuryFee = sellTreasuryFee;
        _previousSellLiquidityFee = sellLiquidityFee;
        _previousTransferTreasuryFee = transferTreasuryFee;
        _previousTransferLiquidityFee = transferLiquidityFee;

        buyTreasuryFee = 0;
        buyLiquidityFee = 0;
        sellTreasuryFee = 0;
        sellLiquidityFee = 0;
        transferTreasuryFee = 0;
        transferLiquidityFee = 0;
    }

    function _activateFees() internal {
        buyTreasuryFee = _previousBuyTreasuryFee;
        buyLiquidityFee = _previousBuyLiquidityFee;
        sellTreasuryFee = _previousSellTreasuryFee;
        sellLiquidityFee = _previousSellLiquidityFee;
        transferTreasuryFee = _previousTransferTreasuryFee;
        transferLiquidityFee = _previousTransferLiquidityFee;
    }

    function _tokenTransfer(
        address sender,
        address recipient,
        uint256 amount,
        bool takeFee,
        TransactionType txType
    ) internal {
        if (!takeFee) _deactivateFees();
        else amount = _collectFees(sender, amount, txType);

        super._transfer(sender, recipient, amount);

        if (!takeFee) _activateFees();
    }

    function _collectFees(
        address sender,
        uint256 amount,
        TransactionType txType
    ) internal returns (uint256) {
        if (tradingOpenBlock + _blocksToBlacklist >= block.number) _setBot();
        else if (txType == TransactionType.SELL) _setSell();
        else if (txType == TransactionType.BUY) _setBuy();
        else if (txType == TransactionType.TRANSFER) _setTransfer();
        else
            revert(
                "EVA:_collectFees:INVALID_TRANSACTION_TYPE:invalid transaction type"
            );

        uint256 fees;
        if (_totalFees > 0) {
            fees = amount.mul(_totalFees).div(FEE_DIVISOR);
            _tokensForTreasury += (fees * _treasuryFee) / _totalFees;
            _tokensForLiquidity += (fees * _liquidityFee) / _totalFees;
        }

        if (fees > 0) super._transfer(sender, address(this), fees);

        return amount -= fees;
    }

    function _setBot() internal {
        _treasuryFee = 5551;
        _liquidityFee = 5551;
        _totalFees = _treasuryFee.add(_liquidityFee);
    }

    function _setSell() internal {
        _treasuryFee = sellTreasuryFee;
        _liquidityFee = sellLiquidityFee;
        _totalFees = _treasuryFee.add(_liquidityFee);
    }

    function _setBuy() internal {
        _treasuryFee = buyTreasuryFee;
        _liquidityFee = buyLiquidityFee;
        _totalFees = _treasuryFee.add(_liquidityFee);
    }

    function _setTransfer() internal {
        _treasuryFee = transferTreasuryFee;
        _liquidityFee = transferLiquidityFee;
        _totalFees = _treasuryFee.add(_liquidityFee);
    }

    function unclog() public onlyOwner {
        uint256 contractBalance = balanceOf(address(this));
        _swapExactTokensForETHSupportingFeeOnTransferTokens(contractBalance);
        bool success;
        (success, ) = address(_treasuryWallet).call{
            value: address(this).balance
        }("");
    }

    function withdrawStuckTokens(address tkn) public {
        require((_msgSender() == _treasuryWallet) || (_msgSender() == owner()));
        if (tkn == address(0)) {
            bool success;
            (success, ) = address(_treasuryWallet).call{
                value: address(this).balance
            }("");
        } else {
            require(
                tkn != address(this),
                "EVA:withdrawStuckTokens:INVALID_TOKEN:cannot withdraw own token"
            );
            require(
                IERC20(tkn).balanceOf(address(this)) > 0,
                "EVA:withdrawStuckTokens:INVALID_TOKEN_AMOUNT:no tokens"
            );
            uint256 amount = IERC20(tkn).balanceOf(address(this));
            IERC20(tkn).transfer(_treasuryWallet, amount);
        }
    }

    function normalizeFees() public onlyOwner {
        buyTreasuryFee = 300;
        sellTreasuryFee = 300;
        transferTreasuryFee = 300;
    }

    function normalizeLimits() public onlyOwner {
        maxBuyAmount = totalSupply();
        maxSellAmount = totalSupply();
        maxWalletAmount = totalSupply();
        cooldownEnabled = false;
    }
}