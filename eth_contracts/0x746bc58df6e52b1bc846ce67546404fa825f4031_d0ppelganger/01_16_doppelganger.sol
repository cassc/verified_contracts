/*0xdb7f99605fd3cc23067c3d8c1ba637109f083dc2,,,,,,,,,,,,?*,,,,,,,,,?,,,,,*,;,,,,,,,,,;,,,..%+;++:,,.,,,:,,,,,,,,;?:;,,,,,,,,,,,,,,?+,,,,,,;,,,,,,:*,,,:;,,,,,;:,,,
;..,,..............::....,,.......:+++;,..............%:.........;;...;+.+........,+...;*#@@@@@#S?:..:+........?%,..............+%::,,:;,......:;...........,;,.
;....:;..........................:;;,...,:;::+?+**;..:S;::,,,,:,,:?,..,,,*........+:..%@@@@@@@@@@@@;.,*.......,+,...............;%,:;::........;;.......,....,,.
;.....,....,............................;?;;*@#@?+%*.*?:.....,,;::++.....*.......,;.,[email protected]@@@@@@@@@@@@#:?+......,+,.................+,,,:.........*;..::...;;;,:+,.
*;,:,......::..............,,..........,*%*+*###:..*:?+,:,..;;+?;++*,.,:,:..,:::+*;.,[email protected]@@@@@@@@@@@@@%,.,::;;;?%:,:,..,,,:,.,;::,:;:,++::;+,,,:;+;::;:;:;::+:,,..
*?:+?;.....................+;,..,:.,,,,,;*,,+,:%?*%#@@@##?+::..:+,,:;..:;;+:;;:::;,:;;@@@@@@@@@@@@@@#,.+S****++:;+;*;:;+*;;;*?+::%?:;;+%S;:::+???%S%:+,;:,:;,...
**;?%%:.........................,:;:;;:;+*+;+:;#@@@@@@@@@@@@?,.,,.,;::,:+?%*;***++;;+*S#[email protected]@@@@@@@@@@@:,##;+;;;:+::**:,[email protected]%;+.%@*.,%%*;.*#S?,.,SSS???+?;;;+,,*,,..
**:*%*,,........................,:+:;+;+;+*++*@@@@@@@@@@@@@@@;,:;+++;+%?%++?++;***??;%??.:+?#@@@@@@@@,[email protected]?+,[email protected]*,;:,*++.,#@:*,:SS,.?%%?+S?%#;..%#?:,.;*::,,,:+:,..
**+,:;,,..............,.,.,,,...,;;:++++;[email protected]@@@@@@@@@@@@@@S,:?%%%?;?#S*%S;S;;;+*SS*S?,...,*@@@@@#*.:#@+;.S#;;;.,;#,.;@%**.:#?.:+?%%S?;%S:.;%%*,,,+?,:,,::,...
+:%;;+::.................:%*?:..,;++*;++**;+**#@@@@@@@@@@@@@@@+,*S%%??;%%*S?;?*%++?S#?*;,.....%@@@@;.,,S#?+,;@S*?#S:#%.,%#+%,.?#:.;S*:?*.?#*..+?%+%%*;,;,:,,....
%*%*++;?:.............;%+;?:%+..,+;;++*::;+;*[email protected]@@@@@@@@@@@@@@?.:#@@%+*%:+*+**%@#S++***:,.....:@@@S,,,:??#?;.*%??*;:%@;.;@??+.+#?.,*%*,;.;%?,.:??%;,,:::;%+.....
S?*++****;............:##,*+?+;.,+:,;@@+:,+++;[email protected]*%#@@@@@@@@@@@%..+%%+*S%+;?;*S?*;+*++SSS%?%:.,[email protected]@@@:..,%S#?,+;,.::++:@S.,#@+#::@S,.;%#:::,*%+..;*??;+;,:+?*,....
%**;;*?*?*.,,......,;:,:%S?:;++.,+:,:**:,,+;;;;*,.,:+%@@@@@@@@?..:;+%%%%S%%%***?**??*#@@#+*,.:%@@@@S,..?*;+,+#S?+;:;.%@:[email protected]?**.*#+.,*%%::,,*%:.,??*+++:,,.:*:...
%+%:++***;,:;,:,::,.;;;;:;***+..,+;;;:,::,;;+;;;,[email protected]@@@@@*,,,:+*%#S?+;:::::;;?#@@#@@*.....,#@@@@@%*%*:+;,[email protected]@?%**.:#*.,#@+*,;#?,.,*S+::,?S*..**++:,*:,,:;,...
?;+:;**+;,,,;:,;,,:.:;;+:,,:,...,;:,+*+;;:;,+;:;:,.....*@@@@*....,,,;;,.........;?S#@@@+.......:++;;*?%%%??%?;SS%*??;,:+,.+%?*+*@#*..+??:;,;?S:.,++:::::.:,.,,..
;.;,.:+.:;;,,,,+:,..,,,,,.......,:,,;*:;:,+:;;,+:;:....:@@@@,...................,;%#@@@?,..................,,,;+;+++**++:.,%%%??+;:,.:+;;::,?+,,.:*+;:..:::,,,..
;.+,,%++%+,,,::,,,,,....,....:;..;,,+;:;+:*++::::;*:..,[email protected]@@@*[email protected]@@@@S,.................,.*?#?**?**+;,,,;%:,:;;++:.+;;;:,,.:,,,::,,:::,.,;,..
+,+,*%+??....::,............;+,.,+,;*::,:;*++;:,;:;:..:%@@@@@:...................*@@@@@@@#;...............,;:#@@*,:;,:+*;;+,,;+++*?*+*+;+S+:,;:;;:.,;+:+;:;+;...
;,:,,,.*:..................,*;,,:+.,*,:,.*##SSS#%,.....:@@@@@@%*:,,............:[email protected]@@@@@S%*;..............,%?%#@@%++;*++;,.;;;:,,+*?S::,:;*+++:++:;+;+++:::;+,...
+,;,...,...................;SS?,+;,:+,.,+?%#@@@@:.......;*%??%S###S???*,[email protected]@@@@*:,................,*#@@@@@@S:::..,,.....:;:..*@%+...,;,,,::,,,:,:,,..,,....
;.:,.......................,,:,.,,......;*#@@@@%,..............,,,,,:;+:,....,#@@@?:[email protected]@@@@@@@S,;;..............,,:,..........................
?,:,....,..,,,,:::,,..............:%;.....:[email protected]@@@#:.....................+?%;..*@@@*.................,..:@@@@@@@@@@%:,;*?%????;+:,,,:,,,,,,,,,;:::;;:.,,..........
*,:,..,..,..,,,:,,,,..,........,..,+,....:[email protected]@@@@@#:..................;.?#@[email protected]@@@:..,,.............,.:#@@@##@@@@@?,.;+*++**?;;:,:,:;:,,,,::,::,.:%?,..,,,,,,,,,,
;.+,.,,,.......,.....,,.........,,,.....+#@@@@@@@@#:................++;[email protected]@#,#@@@@:.,,.......,......,;#@@@@;[email protected]@@@@*::::,,,,,,,:,::,,,,,,,,:,.,,,,,,,,,,,,,,,,,,,,
*:;;:;;;:;;;;;++*??**+*?*?**??%%*?:...,[email protected]@@@@#%*;:,...............,*@###@@@[email protected]@@@%..,,.......,.....,[email protected]@@@@%[email protected]@@@@S+++*+**+*++++++++;;;+:;::,:::::,,,,,,,,,,,.,..
?;S?*???*?%%*%%%S#SS##S##SS##S##S%,..,#@@@@S+,...................;#@@@@@@@@+#@@@;..................%@@@@@%?%@@@@@#*?%?*****?S?**+++;;::::::::::,:,:::::::,,,,,,,
;.?,,,,,,,,,,,,,::;::::::::::::++;,[email protected]@@#;,....................,@@#@@@@@@@[email protected]@@@,[email protected]@@@@@S%%@@@@@#+*SS%??*?????**++*+++;;;;:;;;::;;;:;;::::,:::,
;,?,,,,,,::::::;;;+*?????%??????*;..,#@@@;..................,,..*@@@@@@@@@@@##@@:................:@@@@@@@###@@@@@@%SSS##SSSS#SSSS%????%SS%?????***?%?%%SS%S%?**?
*;%;+;+*++*?+*??%SSSSSSS#%%%?%%*;,,,%@@@@:,,,;,,,,,,,,,,,,,,,,,[email protected]@@@##@@@@@@[email protected]@@;,,,,,,,,,,,,,,,,%@@@@@@@S??#@@@@#S##@@@#S###[email protected]###SS%?*?***%?*+;;:+;;++***?S#@*/

// SPDX-License-Identifier: MIT
pragma solidity ^0.8.19;

import "@openzeppelin/[email protected]/token/ERC721/extensions/ERC721URIStorage.sol";

contract d0ppelganger is ERC721URIStorage {

    constructor() ERC721("d0ppelganger", "D0P2") {
        _creator = msg.sender;
    }

    address private _creator;

    uint public tokenCount = 4;
    uint public maxTokens = 4;

    address public musicMetaData;
    bool metaLock;

    function setMetaDataAddress(address a) public {
        require (msg.sender == _creator && !metaLock);
        musicMetaData = a;
        metaLock = true;
    }

    // structs for submissions mapping
    struct entry {
        string URI;
        string description;
        address Location;
        bool[5] hasVOTED;
        bool[5] isInFAVOR;
        bool ratified;
    }

    uint public submissionCounter;
    mapping (uint => entry) public ArtSubmissionList;

    string[] public ArtListArray;

    event ART_SUBMITED (uint entryNumber);
    event ART_ADDED (uint entryNumber);
    event ART_CHANGED (uint tokenID, uint listNumber);
    event PROLIFERATED ();
    event TRANSFORM(uint sent);

    function SetTokenArt(uint _tokenID, uint listNumber) public {
        require(_isApprovedOrOwner(msg.sender, _tokenID), "Not owner of that token.");
        if (listNumber == 0) {
            require(_isApprovedOrOwner(msg.sender, 0), "nedry.gif // 0 is just for 0");
        }
        _setTokenURI(_tokenID, ArtListArray[listNumber]);
        emit ART_CHANGED(_tokenID, listNumber);
    } 

    // MiniDAO Functionality

    function SubmitArt(string memory newURI, string memory description, address mintedAddress) public {
        submissionCounter++;
        ArtSubmissionList[submissionCounter].URI = newURI;
        ArtSubmissionList[submissionCounter].description = description;
        ArtSubmissionList[submissionCounter].Location = mintedAddress;
        emit ART_SUBMITED(submissionCounter);
    }

    function VoteFor (uint _tokenID, uint entryNumber) public {
        _VOTE(_tokenID, entryNumber, true);
    }

    function VoteAgainst (uint _tokenID, uint entryNumber) public {
        _VOTE(_tokenID, entryNumber, false);
    }

    function _VOTE (uint _tokenID, uint _entryNumber, bool _inFavor) private {
        require(_tokenID >= 0 && _tokenID <= 4, "Must hold at least one of token 0-4");
        require(_isApprovedOrOwner(msg.sender, _tokenID), "Must own the token you're submitting a vote for.");
        require (submissionCounter >= _entryNumber && _entryNumber != 0, "This entry number doesn't exist yet.");
        require (!ArtSubmissionList[_entryNumber].hasVOTED[_tokenID], "You have already voted on this entry.");

        ArtSubmissionList[_entryNumber].hasVOTED[_tokenID] = true;
        ArtSubmissionList[_entryNumber].isInFAVOR[_tokenID] = _inFavor;


        if (_tokenID == 0) {
            for (uint i = 1; i <= 4; i++) {
                ArtSubmissionList[_entryNumber].hasVOTED[i] = true;
                ArtSubmissionList[_entryNumber].isInFAVOR[i] = _inFavor;
            }
            
        }
        if (ArtSubmissionList[_entryNumber].isInFAVOR[_tokenID]) {
            _calculateVotes(_entryNumber);
        }
    }

    function _calculateVotes(uint _entryNumber) private {
        uint totalVotesInFavor = 0;
        uint totalVotes = 0;

        for (uint i = 1; i < 5; i++) {
            if (ArtSubmissionList[_entryNumber].hasVOTED[i]) {
                totalVotes++;
                if (ArtSubmissionList[_entryNumber].isInFAVOR[i]) {
                    totalVotesInFavor++;
                }
            }
        }

        if (totalVotes >= 4 && totalVotesInFavor >= 4) {
            ArtSubmissionList[_entryNumber].ratified = true;
            ArtListArray.push(ArtSubmissionList[_entryNumber].URI);
            emit ART_ADDED(_entryNumber);
        }
    }

    function GetVotesByEntry(uint entryNumber) public view returns (bool[8] memory) {
        bool[8] memory list;
        for (uint i = 0; i < 4; i++) {
            list[i] = ArtSubmissionList[entryNumber].hasVOTED[i + 1];
            list[i + 4] = ArtSubmissionList[entryNumber].isInFAVOR[i + 1];
        }
        return list;
    }

    // used as burn address for (in)visibility
    address burner = 0x000000000000000000000000000000000000dEaD;

    bool initialized;

    function initialize() public {
        require (initialized == false, "Already initialized.");
        ArtListArray.push("https://arweave.net/R6Gzqt7E9fdP-GTf5_lUcg99oqKQiOd5C8zBBK0E8Gw");
        ArtListArray.push("https://arweave.net/wQJ_WFJUoHg2tSSAuE-YXJA4LGkzR95exbWnyF_I07c");
        ArtListArray.push("https://arweave.net/DvKbz7kRh8uMfjyDQdM2Pu_6GGH48CH38lxUBtqYOxc");
        ArtListArray.push("https://arweave.net/z0vID8o-0UQOAcnNoHnx2jPLn3GsoZ0hllUd4e7OPV8");
        ArtListArray.push("https://arweave.net/lmQIBOg1HxgqlHMBtEeID96KKhyyB32WvGqrzSi8xco");
        _safeMint(burner, 0);
        _safeMint(_creator, 1);
        _safeMint(_creator, 2);
        _safeMint(_creator, 3);
        _safeMint(_creator, 4);
        _setTokenURI(0, ArtListArray[0]);
        _setTokenURI(1, ArtListArray[1]);
        _setTokenURI(2, ArtListArray[2]);
        _setTokenURI(3, ArtListArray[3]);
        _setTokenURI(4, ArtListArray[4]);
        initialized = true;
    }

    // FULL OWNERSHIP FUNCTIONS

    // Turns 4 tokens owns into 1
    function zCONSOLIDATE() public {
        require (_isApprovedOrOwner(_msgSender(), 1) && _isApprovedOrOwner(_msgSender(), 2) && _isApprovedOrOwner(_msgSender(), 3) && _isApprovedOrOwner(_msgSender(), 4), "Must hold tokens 1-4.");
        _transfer(msg.sender, burner, 1);
        _transfer(msg.sender, burner, 2);
        _transfer(msg.sender, burner, 3);
        _transfer(msg.sender, burner, 4);
        _transfer(burner, msg.sender, 0);
        emit TRANSFORM(4);
    }

    // Turns the 1 back into 4
    function zDISINTEGRATE() public {
        require (_isApprovedOrOwner(_msgSender(), 0), "Must hold token 0");
        _transfer(burner, msg.sender, 1);
        _transfer(burner, msg.sender, 2);
        _transfer(burner, msg.sender, 3);
        _transfer(burner, msg.sender, 4);
        _transfer(msg.sender, burner, 0);
        emit TRANSFORM(1);
    }


    // Makes new tokens mintable up to 969
    function zPROLIFERATE() public {
        require (_isApprovedOrOwner(_msgSender(), 0), "Must hold token 0");
        maxTokens = 972;
        emit PROLIFERATED();
    }

    // Cost of newly mintable tokens in wei
    uint zCOSTwei = 100000000000000000;

    function zSETCOST(uint COSTwei) public {
        require (_isApprovedOrOwner(_msgSender(), 0), "Must hold token 0");
        zCOSTwei = COSTwei;
    }

    function safeMint(address to)
        public
        payable
    {
        require (msg.value == zCOSTwei, "Incorrect ether value sent");
        require (tokenCount < maxTokens, "Max supply met");
        tokenCount++;
        _safeMint(to, tokenCount);
        _setTokenURI(tokenCount, ArtListArray[1]);
    }

    address public withdrawAddress = _creator;

    // Change withdraw address to set up DAO or whatever holder decides
    function zSETWITHDRAW(address newAdress ) public {
        require (_isApprovedOrOwner(_msgSender(), 0), "Must hold token 0");
        withdrawAddress = newAdress;
    }

    function withdraw() public {
        uint balance = address(this).balance;
        require(balance > 0, "No balance to withdraw");
        payable(withdrawAddress).transfer(balance);
    }

    // The following functions are overrides required by Solidity.

    function _burn(uint256 tokenId) internal override(ERC721URIStorage) {
        super._burn(tokenId);
    }

    function tokenURI(uint256 tokenId)
        public
        view
        override(ERC721URIStorage)
        returns (string memory)
    {
        return super.tokenURI(tokenId);
    }

    function supportsInterface(bytes4 interfaceId)
        public
        view
        override(ERC721URIStorage)
        returns (bool)
    {
        return super.supportsInterface(interfaceId);
    }

}