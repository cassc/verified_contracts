//       /$$ /$$ /$$ /$$ /$$ /$$ /$$$$   /$$$$   /$$$$   /$$$$   /$$$$   /$$$$   /$$$$   /$$$$   /$$$$      /$$ /$$ /$$ /$$ /$$ /$$ /$$ /$$ /$$
//     /$$//$$//$$//$$//$$//$$//$$  $$ /$$  $$ /$$  $$ /$$  $$ /$$  $$ /$$  $$ /$$  $$ /$$  $$ /$$  $$    /$$//$$//$$//$$//$$//$$//$$//$$//$$/
//     /$$//$$//$$//$$//$$//$$/|__/\ $$|__/\ $$|__/\ $$|__/\ $$|__/\ $$|__/\ $$|__/\ $$|__/\ $$|__/\ $$   /$$//$$//$$//$$//$$//$$//$$//$$//$$/ 
//    /$$//$$//$$//$$//$$//$$/     /$$/    /$$/    /$$/    /$$/    /$$/    /$$/    /$$/    /$$/    /$$/  /$$//$$//$$//$$//$$//$$//$$//$$//$$/  
//   /$$//$$//$$//$$//$$//$$/     /$$/    /$$/    /$$/    /$$/    /$$/    /$$/    /$$/    /$$/    /$$/  /$$//$$//$$//$$//$$//$$//$$//$$//$$/   
//  /$$//$$//$$//$$//$$//$$/     |__/    |__/    |__/    |__/    |__/    |__/    |__/    |__/    |__/  /$$//$$//$$//$$//$$//$$//$$//$$//$$/    
// /$$//$$//$$//$$//$$//$$/       /$$     /$$     /$$     /$$     /$$     /$$     /$$     /$$     /$$ /$$//$$//$$//$$//$$//$$//$$//$$//$$/     
//|__/|__/|__/|__/|__/|__/       |__/    |__/    |__/    |__/    |__/    |__/    |__/    |__/    |__/|__/|__/|__/|__/|__/|__/|__/|__/|__/                                                                                                                                                 
// /$$   /$$ /$$   /$$ /$$   /$$ /$$   /$$  /$$$$$$  /$$      /$$ /$$   /$$        /$$$$$$   /$$$$$$  /$$       /$$       /$$$$$$$$  /$$$$$$  /$$$$$$$$ /$$$$$$  /$$$$$$  /$$   /$$
//| $$  | $$| $$$ | $$| $$  /$$/| $$$ | $$ /$$__  $$| $$  /$ | $$| $$$ | $$       /$$__  $$ /$$__  $$| $$      | $$      | $$_____/ /$$__  $$|__  $$__/|_  $$_/ /$$__  $$| $$$ | $$
//| $$  | $$| $$$$| $$| $$ /$$/ | $$$$| $$| $$  \ $$| $$ /$$$| $$| $$$$| $$      | $$  \__/| $$  \ $$| $$      | $$      | $$      | $$  \__/   | $$     | $$  | $$  \ $$| $$$$| $$
//| $$  | $$| $$ $$ $$| $$$$$/  | $$ $$ $$| $$  | $$| $$/$$ $$ $$| $$ $$ $$      | $$      | $$  | $$| $$      | $$      | $$$$$   | $$         | $$     | $$  | $$  | $$| $$ $$ $$
//| $$  | $$| $$  $$$$| $$  $$  | $$  $$$$| $$  | $$| $$$$_  $$$$| $$  $$$$      | $$      | $$  | $$| $$      | $$      | $$__/   | $$         | $$     | $$  | $$  | $$| $$  $$$$
//| $$  | $$| $$\  $$$| $$\  $$ | $$\  $$$| $$  | $$| $$$/ \  $$$| $$\  $$$      | $$    $$| $$  | $$| $$      | $$      | $$      | $$    $$   | $$     | $$  | $$  | $$| $$\  $$$
//|  $$$$$$/| $$ \  $$| $$ \  $$| $$ \  $$|  $$$$$$/| $$/   \  $$| $$ \  $$      |  $$$$$$/|  $$$$$$/| $$$$$$$$| $$$$$$$$| $$$$$$$$|  $$$$$$/   | $$    /$$$$$$|  $$$$$$/| $$ \  $$
// \______/ |__/  \__/|__/  \__/|__/  \__/ \______/ |__/     \__/|__/  \__/       \______/  \______/ |________/|________/|________/ \______/    |__/   |______/ \______/ |__/  \__/
// /$$   /$$ /$$   /$$ /$$   /$$ /$$   /$$  /$$$$$$  /$$      /$$ /$$   /$$        /$$$$$$  /$$$$$$$  /$$$$$$$$       /$$      /$$  /$$$$$$  /$$$$$$$  /$$   /$$  /$$$$$$ 
//| $$  | $$| $$$ | $$| $$  /$$/| $$$ | $$ /$$__  $$| $$  /$ | $$| $$$ | $$       /$$__  $$| $$__  $$|__  $$__/      | $$  /$ | $$ /$$__  $$| $$__  $$| $$  /$$/ /$$__  $$
//| $$  | $$| $$$$| $$| $$ /$$/ | $$$$| $$| $$  \ $$| $$ /$$$| $$| $$$$| $$      | $$  \ $$| $$  \ $$   | $$         | $$ /$$$| $$| $$  \ $$| $$  \ $$| $$ /$$/ | $$  \__/
//| $$  | $$| $$ $$ $$| $$$$$/  | $$ $$ $$| $$  | $$| $$/$$ $$ $$| $$ $$ $$      | $$$$$$$$| $$$$$$$/   | $$         | $$/$$ $$ $$| $$  | $$| $$$$$$$/| $$$$$/  |  $$$$$$ 
//| $$  | $$| $$  $$$$| $$  $$  | $$  $$$$| $$  | $$| $$$$_  $$$$| $$  $$$$      | $$__  $$| $$__  $$   | $$         | $$$$_  $$$$| $$  | $$| $$__  $$| $$  $$   \____  $$
//| $$  | $$| $$\  $$$| $$\  $$ | $$\  $$$| $$  | $$| $$$/ \  $$$| $$\  $$$      | $$  | $$| $$  \ $$   | $$         | $$$/ \  $$$| $$  | $$| $$  \ $$| $$\  $$  /$$  \ $$
//|  $$$$$$/| $$ \  $$| $$ \  $$| $$ \  $$|  $$$$$$/| $$/   \  $$| $$ \  $$      | $$  | $$| $$  | $$   | $$         | $$/   \  $$|  $$$$$$/| $$  | $$| $$ \  $$|  $$$$$$/
//\______/ |__/  \__/|__/  \__/|__/  \__/ \______/ |__/     \__/|__/  \__/      |__/  |__/|__/  |__/   |__/         |__/     \__/ \______/ |__/  |__/|__/  \__/ \______/ 
///$$   /$$ /$$   /$$ /$$   /$$ /$$   /$$  /$$$$$$  /$$      /$$ /$$   /$$        /$$$$$$  /$$$$$$$  /$$$$$$$$  /$$$$$$  /$$$$$$$$ /$$$$$$  /$$$$$$$ 
//| $$  | $$| $$$ | $$| $$  /$$/| $$$ | $$ /$$__  $$| $$  /$ | $$| $$$ | $$       /$$__  $$| $$__  $$| $$_____/ /$$__  $$|__  $$__//$$__  $$| $$__  $$
//| $$  | $$| $$$$| $$| $$ /$$/ | $$$$| $$| $$  \ $$| $$ /$$$| $$| $$$$| $$      | $$  \__/| $$  \ $$| $$      | $$  \ $$   | $$  | $$  \ $$| $$  \ $$
//| $$  | $$| $$ $$ $$| $$$$$/  | $$ $$ $$| $$  | $$| $$/$$ $$ $$| $$ $$ $$      | $$      | $$$$$$$/| $$$$$   | $$$$$$$$   | $$  | $$  | $$| $$$$$$$/
//| $$  | $$| $$  $$$$| $$  $$  | $$  $$$$| $$  | $$| $$$$_  $$$$| $$  $$$$      | $$      | $$__  $$| $$__/   | $$__  $$   | $$  | $$  | $$| $$__  $$
//| $$  | $$| $$\  $$$| $$\  $$ | $$\  $$$| $$  | $$| $$$/ \  $$$| $$\  $$$      | $$    $$| $$  \ $$| $$      | $$  | $$   | $$  | $$  | $$| $$  \ $$
//|  $$$$$$/| $$ \  $$| $$ \  $$| $$ \  $$|  $$$$$$/| $$/   \  $$| $$ \  $$      |  $$$$$$/| $$  | $$| $$$$$$$$| $$  | $$   | $$  |  $$$$$$/| $$  | $$
//\______/ |__/  \__/|__/  \__/|__/  \__/ \______/ |__/     \__/|__/  \__/       \______/ |__/  |__/|________/|__/  |__/   |__/   \______/ |__/  |__/
///$$$$$$ /$$$$$$$$ /$$ /$$$$$$         /$$$$$$  /$$       /$$             /$$   /$$ /$$   /$$ /$$   /$$ /$$   /$$  /$$$$$$  /$$      /$$ /$$   /$$
//|_  $$_/|__  $$__/| $//$$__  $$       /$$__  $$| $$      | $$            | $$  | $$| $$$ | $$| $$  /$$/| $$$ | $$ /$$__  $$| $$  /$ | $$| $$$ | $$
//  | $$     | $$   |_/| $$  \__/      | $$  \ $$| $$      | $$            | $$  | $$| $$$$| $$| $$ /$$/ | $$$$| $$| $$  \ $$| $$ /$$$| $$| $$$$| $$
//  | $$     | $$      |  $$$$$$       | $$$$$$$$| $$      | $$            | $$  | $$| $$ $$ $$| $$$$$/  | $$ $$ $$| $$  | $$| $$/$$ $$ $$| $$ $$ $$
//  | $$     | $$       \____  $$      | $$__  $$| $$      | $$            | $$  | $$| $$  $$$$| $$  $$  | $$  $$$$| $$  | $$| $$$$_  $$$$| $$  $$$$
//  | $$     | $$       /$$  \ $$      | $$  | $$| $$      | $$            | $$  | $$| $$\  $$$| $$\  $$ | $$\  $$$| $$  | $$| $$$/ \  $$$| $$\  $$$
// /$$$$$$   | $$      |  $$$$$$/      | $$  | $$| $$$$$$$$| $$$$$$$$      |  $$$$$$/| $$ \  $$| $$ \  $$| $$ \  $$|  $$$$$$/| $$/   \  $$| $$ \  $$
//|______/   |__/       \______/       |__/  |__/|________/|________/       \______/ |__/  \__/|__/  \__/|__/  \__/ \______/ |__/     \__/|__/  \__/

pragma solidity ^0.8.9;

import "@openzeppelin/contracts/token/ERC721/ERC721.sol";
import "@openzeppelin/contracts/access/Ownable.sol";
import "@openzeppelin/contracts/security/ReentrancyGuard.sol";
import "@openzeppelin/contracts/utils/Counters.sol";
import "@openzeppelin/contracts/utils/Address.sol";

contract Unknown is ERC721, ReentrancyGuard, Ownable {
  using Counters for Counters.Counter;

  constructor(string memory customBaseURI_) ERC721("Unknown", "UNK") {
    customBaseURI = customBaseURI_;

    allowedMintCountMap[owner()] = 9;
  }

  /** MINTING LIMITS **/

  mapping(address => uint256) private mintCountMap;

  mapping(address => uint256) private allowedMintCountMap;

  uint256 public constant MINT_LIMIT_PER_WALLET = 2;

  function max(uint256 a, uint256 b) private pure returns (uint256) {
    return a >= b ? a : b;
  }

  function allowedMintCount(address minter) public view returns (uint256) {
    if (saleIsActive) {
      return (
        max(allowedMintCountMap[minter], MINT_LIMIT_PER_WALLET) -
        mintCountMap[minter]
      );
    }

    return allowedMintCountMap[minter] - mintCountMap[minter];
  }

  function updateMintCount(address minter, uint256 count) private {
    mintCountMap[minter] += count;
  }

  /** MINTING **/

  uint256 public constant MAX_SUPPLY = 999;

  uint256 public constant MAX_MULTIMINT = 2;

  uint256 public constant PRICE = 8999999999999999;

  Counters.Counter private supplyCounter;

  function mint(uint256 count) public payable nonReentrant {
    if (allowedMintCount(msg.sender) >= count) {
      updateMintCount(msg.sender, count);
    } else {
      revert(saleIsActive ? "Minting limit exceeded" : "Sale not active");
    }

    require(totalSupply() + count - 1 < MAX_SUPPLY, "Exceeds max supply");

    require(count <= MAX_MULTIMINT, "Mint at most 2 at a time");

    require(
      msg.value >= PRICE * count, "Insufficient payment, 0.009 ETH per item"
    );

    for (uint256 i = 0; i < count; i++) {
      _mint(msg.sender, totalSupply());

      supplyCounter.increment();
    }
  }

  function totalSupply() public view returns (uint256) {
    return supplyCounter.current();
  }

  /** ACTIVATION **/

  bool public saleIsActive = false;

  function setSaleIsActive(bool saleIsActive_) external onlyOwner {
    saleIsActive = saleIsActive_;
  }

  /** URI HANDLING **/

  string private customBaseURI;

  function setBaseURI(string memory customBaseURI_) external onlyOwner {
    customBaseURI = customBaseURI_;
  }

  function _baseURI() internal view virtual override returns (string memory) {
    return customBaseURI;
  }

  function tokenURI(uint256) public view override returns (string memory) {
    return _baseURI();
  }

  /** PAYOUT **/

  function withdraw() public nonReentrant {
    uint256 balance = address(this).balance;

    Address.sendValue(payable(owner()), balance);
  }
}